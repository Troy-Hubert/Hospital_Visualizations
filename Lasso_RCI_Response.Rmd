---
title: "Lasso_RCI_Response"
author: Troy Hubert
output: html_document
date: "2024-01-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Libraries
library(tidyverse)
library(dplyr)
library(haven)
library(ggplot2)
library(tidyr)
library(fuzzySim) ## For FDR adjusted p values
library(broom) # for tidy regression output
```

# Prep data for analysis 

## Read in the dataset. 
```{r}
Mothership1 <- read_sav("~/Desktop/Coding/data/PHPoutcome_clean.sav")
#DF_1<- read_sav("~/Desktop/Coding/data/PHPoutcome_clean.sav")
Mothership1

list.files("~/Desktop/Coding/data/ACT_scores")
# path = "~/Desktop/Coding/data/ACT_scores"
# # 
# length(dir(path))
# for(i in dir(path))
# {
#   df_1 <- read_sav(paste0(path,"/",i))
#   Mothership_mindful <- left_join(Mothership1,df_1, by = join_by(ID1 == ID1))
# }


df_1 <- read_sav("~/Desktop/Coding/data/ACT_scores/AAQIIPost_1.sav")
Mothership1 <- left_join(Mothership1,df_1, by = join_by(ID1 == ID1))
df_2 <- read_sav("~/Desktop/Coding/data/ACT_scores/AAQIIPre_1.sav")
Mothership1 <- left_join(Mothership1,df_2, by = join_by(ID1 == ID1))
df_3 <- read_sav("~/Desktop/Coding/data/ACT_scores/FFMQPost_1.sav")
Mothership1 <- left_join(Mothership1,df_3, by = join_by(ID1 == ID1))
df_4 <- read_sav("~/Desktop/Coding/data/ACT_scores/FFMQPost_4250-4350.sav")
Mothership1 <- left_join(Mothership1,df_4, by = join_by(ID1 == ID1))
df_5 <- read_sav("~/Desktop/Coding/data/ACT_scores/FFMQPre_1.sav")
Mothership1 <- left_join(Mothership1,df_5, by = join_by(ID1 == ID1))


view(Mothership_mindful)
```

```{r}

```




## Clean, update, and wrangle data

The code below reads in the data frame, and prepares df for analysis.

this includes:
  1 Re-coding / Renaming variables
  2 Creating new Diagnostic variables 
  3 Functions to create Pre - post scores 
  4 RCI Analysis categorization
  5 Pre - Post long data sets

```{r}
# 1. Re-coding / Renaming variables ------------------------------------------
# We can change the current variables to make them easier to interpret.

#recode varaibles
Mothership <- mutate(Mothership, 
                     Education_1 = as.factor(Education_1),
                     Education_1 = recode(Education_1,
                                          "0"="<Grade 12",
                                          "1"="<Grade 12",
                                          "2"="HS Diploma or GED",
                                          "3"="HS Diploma or GED",
                                          "4"="Some College/Associates Degree",
                                          "5"="Some College/Associates Degree",
                                          "6"="Bachelors Degree",
                                          "7"="Bachelors Degree",
                                          "8"="Grad Degree"),
                     Some_College = Education_1,
                     Some_College = recode(Education_1,
                                          "<Grade 12" = "0",
                                          "<Grade 12" = "0",
                                          "HS Diploma or GED" = "0",
                                          "HS Diploma or GED" = "0",
                                          "Some College/Associates Degree" = "1",
                                          "Some College/Associates Degree" = "1",
                                          "Bachelors Degree" = "1",
                                          "Bachelors Degree" = "1",
                                          "Grad Degree" ="1"),
                     Gender_1 = as.factor(Gender_1),
                     Gender_1 = recode(Gender_1,
                                       "0"="Female",
                                       "1"="Male",
                                       "2"="Non-Binary",
                                       "3"="Other",
                                       "4"="Other"),
                     Female = Gender_1,
                     Female= recode(Gender_1,
                                       "Female" = "1",
                                       "Male" = "0",
                                       "Non-Binary" = "0",
                                       "Other" = "0",
                                       "Other" = "0"),
                      Relationship_1 = ifelse(Relationship_1 == 8, NA, Relationship_1),
                     Relationship_1 = as.factor(Relationship_1),
                     Relationship_1 = recode(Relationship_1,
                                             "0"="Married or Cohabitating",
                                             "1"="Married or Cohabitating",
                                             "2"="Widowed or Separated",
                                             "3"="Widowed or Separated",
                                             "4"="Divorced",
                                             "5"="Single or Never Married"),
                     Married = recode(Relationship_1,
                                             "Married or Cohabitating" = "1",
                                             "Widowed or Separated" = "0",
                                             "Divorced" = "0",
                                             "Single or Never Married" = "0"),
                     Sexuality_1 = as.factor(Sexuality_1),
                     Sexuality_1 = recode(Sexuality_1,
                                          "1"="Straight",
                                          "2"="Gay",
                                          "3"="Bisexual",
                                          "4"="Other"),
                     Straight = recode(Sexuality_1,
                                         "Straight" = "1",
                                          "Gay" = "0",
                                          "Bisexual" = "0",
                                          "Other" = "0"),
                     IPT_track_1 = as.factor(IPT_track_1),
                     IPT_track_1 = recode(IPT_track_1,
                                          "0"="General",
                                          "1"="Trauma",
                                          "2"="Young Adult",
                                          "3"="BPD"),
                     Race_1 = ifelse(Race_1 == 6, NA, Race_1),
                     Race_1 = as.factor(Race_1),
                     Race_1 = recode(Race_1,
                                     "0"="White",
                                     "1"="Black",
                                     "2"="Hispanic",
                                     "3"="Asian",
                                     "4"="Portugese",
                                     "5"="Other"),
                     White = recode(Race_1,
                                     "White" = "1",
                                     "Black" = "0",
                                     "Hispanic"="0",
                                     "Asian"="0",
                                     "Portugese"="0",
                                     "Other"="0"),
                     DC_status_1 = as.factor(DC_status_1),
                     DC_status_1 = recode(DC_status_1,
                                          "1" ="Treatment Complete",
                                          "2" ="Treatment nearly complete",
                                          "3" ="Insurance no longer covering",
                                          "4" ="Nonattendance",
                                          "5" ="Inappropriate (language)/Referred to another tx setting",
                                          "6" ="Transferred to inpatient",
                                          "7" ="Withdrew due to external limitations",
                                          "8"= "Withdrew AMA",
                                          "9"= "Other",
                                          "10"="Other",
                                          "0" ="Other"),
                     Discharge = recode(DC_status_1,
                                          "Treatment Complete" = "1",
                                          "Treatment nearly complete" = "1",
                                          "Insurance no longer covering" = "0",
                                          "Nonattendance" = "0",
                                          "Inappropriate (language)/Referred to another tx setting" ="0",
                                          "Transferred to inpatient"="0",
                                          "Withdrew due to external limitations"="0",
                                          "Withdrew AMA"="0",
                                          "Other"="0",
                                          "Other"="0",
                                          "Other"="0"),
#Lets make some new variables 
                     #Duration of treatment
                     Duration = as.factor(
                       ifelse(Days_complete_1>0 & Days_complete_1 <=5, "1",
                              ifelse(Days_complete_1>5 & Days_complete_1 <=10, "2",
                                     ifelse(Days_complete_1>10 & Days_complete_1 <=15, "3",
                                            ifelse(is.na(Days_complete_1), NA, "4"
                                            ))))),
                     Duration_lab = as.factor(recode(Duration,
                                                     "1"="1-5",
                                                     "2"="6-10",
                                                     "3"="11-15",
                                                     "4"="16+")),
                     Duration_10 = as.factor(
                       ifelse(Duration == 1 | Duration == 2, "1",
                              ifelse(Duration == 3 | Duration == 4, "2", NA)
                       )))

#Extract Year From Intake Date
#Convert to Date
library("lubridate")
Mothership$Intake_1<-ymd(Mothership$Intake_1)
Mothership$TxYear<-as.numeric(format(Mothership$Intake_1,"%Y"))
Mothership<-mutate(Mothership,
                   TxYear = as.factor(TxYear),
                   TxYear = recode(TxYear,
                                   "1582"="2014"))

####  Export as CSV
write.csv(Mothership,"~/Desktop/Coding/data/Mothership_paper")

# 2. Creating new diagnostic variables  -----------------------------------

Mothership<-Mothership %>%
  mutate(
    # Mood Disorders
    Mood_D = as.factor(
      ifelse(
        MDD_P ==1 | Bipolar1_P == 1 | Bipolar2_P == 1 | Dysthymia_P == 1, 1, 0)),
    # Anxiety Disorders
    Anxiety_D = as.factor(
      ifelse(
        GAD_P ==1 | Panic_P == 1 | PanicAgor_P == 1 | Agoraphobia_P == 1 |
          Social_P == 1 | Specific_P == 1 | OCD_P == 1, 1, 0)),
    # Obsessive Compusive Disorders
    #OCD_P is for current OCD
        #OCD_P = as.factor(OCD_P),
    # Personality Disorders
    #BPD_P is for current BPD
    BPD_P = as.factor(BPD_P),
    # Substance Use Disorders
    Substance_D = as.factor(
      ifelse(
        Alcohol_P == 1 | Drug_P ==1, 1, 0)),
    # Trauma or stresor related disorders
    Trauma_D = as.factor(
      ifelse(PTSD_P == 1 | Adjustment_P ==1, 1,0)),
    # Psychotic Disorders
    Psychotic_D = as.factor(
      ifelse(
        Schiz_P == 1 | Schizaff_P == 1,1,0)),
    # Eating Disorders
    Eating_D = as.factor(
      ifelse(
        Anorex_P == 1 | Bulim_P == 1 | Binge_P == 1, 1,0)),
    # Somatic Disroders
    Somatic_D = as.factor(
      ifelse(
        Somat_P == 1 | UndiffSoma_P == 1| Hypochondriasis_P ==1,
        1,0)),
    Other = as.factor(
      ifelse(
        Somat_P == 1 | UndiffSoma_P == 1| Hypochondriasis_P ==1 |
          Anorex_P == 1 | Bulim_P == 1 | Binge_P == 1 |
            Schiz_P == 1 | Schizaff_P == 1 |
            Alcohol_P == 1 | Drug_P ==1,
        1,0)),
    Disorder_Type = as.factor(
      ifelse(Anxiety_D == 1, "Anxiety",
                    ifelse(BPD_P == 1, "BPD",
                           ifelse(Substance_D == 1, "Substance Use",
                                  ifelse(Trauma_D == 1, "Trauma",
                                         ifelse(Mood_D == 1, "Mood",
                                                ifelse(Psychotic_D == 1, "Psychotic", 
                                                       ifelse(Eating_D == 1, "Eating", 
                                                              ifelse(Somatic_D == 1, "Somatic", NA
                                                              ))))))))),
    Disorder_treat = as.factor(
      ifelse(Anxiety_D == 1, "Anxiety",
             ifelse(BPD_P == 1, "BPD",
                    ifelse(Trauma_D == 1, "Trauma",
                           ifelse(Mood_D == 1, "Mood",
                                         ifelse(Substance_D == 1, "Other",
                                                ifelse(Psychotic_D == 1, "Other", 
                                                       ifelse(Eating_D == 1, "Other",
                                                          ifelse(Somatic_D == 1, "Other",NA
                                                       ))))))))),
    Anxiety_C =  as.factor(
      ifelse( GAD_P !=1 & GAD_C ==1 | 
                Panic_P != 1 & Panic_C == 1 | 
                PanicAgor_P != 1 & PanicAgor_C == 1 | 
                Agoraphobia_P != 1 & Agoraphobia_C == 1 |
                Social_P != 1 & Social_C == 1 | 
                #OCD_P != 1 & OCD_C == 1 |
                Specific_P != 1 & Specific_C == 1, 1, 0)),
    Mood_C =  as.factor(
      ifelse( MDD_P != 1 & MDD_C == 1 |
                Bipolar1_P != 1 & Bipolar1_C == 1 | 
                Bipolar2_P != 1 &  Bipolar2_C == 1 | 
                Dysthymia_P != 1 & Dysthymia_C == 1 , 1, 0)),
    Substance_C = as.factor(
      ifelse(Alcohol_P != 1 & Alcohol_C == 1 | 
               Drug_P != 1 & Drug_C ==1, 1, 0)),
    Trauma_C = as.factor(
      ifelse(PTSD_P != 1 & PTSD_C == 1 | 
               Adjustment_P != 1 & Adjustment_C ==1, 1,0)),
    Psychotic_C = as.factor(
      ifelse(Schiz_P != 1 & Schiz_C == 1 | 
               Schizaff_P != 1 & Schizaff_C == 1,1,0)),
    Eating_C = as.factor(
      ifelse(Anorex_P != 1 & Anorex_C == 1 | 
               Bulim_P != 1 & Bulim_C == 1 | 
                  Binge_P != 1 & Binge_C == 1, 1,0)),
    Somatic_C = as.factor(
      ifelse(Somat_P != 1 & Somat_C == 1 | 
               UndiffSoma_P != 1 & UndiffSoma_C == 1 | 
               Hypochondriasis_P != 1 &  Hypochondriasis_C == 1, 1,0)),
    Other_C = as.factor(
      ifelse(
        Somatic_C == 1 | Eating_C == 1 | Psychotic_C == 1, 1, 0)),

    #OCD_Co_C = as.factor(
     # ifelse(OCD_P != 1 & OCD_C == 1,1,0)),
    BPD_Co_C = as.factor(
      ifelse(BPD_P != 1 & BPD_C ==1,1,0)),
    No_Co = as.factor(
      ifelse(BPD_Co_C == 0 &
               Somatic_C == 0 & 
               Eating_C == 0 &
               Psychotic_C == 0 &
               Trauma_C == 0 & 
               Substance_C == 0 &
               Mood_C == 0 &
               Anxiety_C == 0, 1,0)),
    Other_Co = as.factor(
      ifelse(  Somatic_C == 1 & 
               Eating_C == 1, 1,0)),
    
    #emotional disorders
    Emotional_dis = as.factor(
      ifelse(Anxiety_D == 1 | OCD_P == 1 | Trauma_D == 1 |
               Mood_D == 1, "Emotional Disorder", "Other Disorder")),
    
    # co occuring disorders
    Co_Anx = as.factor(
      ifelse(Anxiety_C == 1 & Mood_D == 1 |
               Anxiety_C == 1 & BPD_P == 1 |
               Anxiety_C == 1 & Substance_D == 1 |
               Anxiety_C == 1 & Trauma_D == 1 |
               Anxiety_C == 1 & Eating_D ==1 |
               Anxiety_C == 1 & Psychotic_D ==1 |
               Anxiety_C == 1 & Somatic_D ==1, 1, 0)),
    Co_Mood = as.factor(
      ifelse(Mood_C == 1 & Anxiety_D == 1 |
               Mood_C == 1 & BPD_P == 1 |
               Mood_C == 1 & Substance_D == 1 |
               Mood_C == 1 & Trauma_D == 1 |
               Mood_C == 1 & Eating_D ==1 |
               Mood_C == 1 & Psychotic_D ==1 |
               Mood_C == 1 & Somatic_D==1 , 1, 0)),
    Co_BPD = as.factor(
      ifelse(BPD_Co_C == 1 & Anxiety_D == 1 |
               BPD_Co_C == 1 & Mood_D == 1 |
               BPD_Co_C == 1 & Substance_D == 1 |
               BPD_Co_C == 1 & Trauma_D == 1 |
               BPD_Co_C == 1 & Eating_D ==1 |
               BPD_Co_C == 1 & Psychotic_D ==1 |
               BPD_Co_C == 1 & !BPD_P == 1 |
               BPD_Co_C == 1 & Somatic_D ==1 , 1, 0)),
    Co_Psychotic = as.factor(
      ifelse(Psychotic_C == 1 & Mood_D == 1 |
               Psychotic_C == 1 & BPD_P == 1 |
               Psychotic_C == 1 & Substance_D == 1 |
               Psychotic_C == 1 & Trauma_D == 1 |
               Psychotic_C == 1 & Eating_D ==1 |
               Psychotic_C == 1 & Anxiety_D ==1 |
               Psychotic_C == 1 & Somatic_D ==1, 1, 0)),
    Co_Eating = as.factor(
      ifelse(Eating_C == 1 & Mood_D == 1 |
               Eating_C == 1 & BPD_P == 1 |
               Eating_C == 1 & Substance_D == 1 |
               Eating_C == 1 & Trauma_D == 1 |
               Eating_C == 1 & Psychotic_D ==1 |
               Eating_C == 1 & Anxiety_D ==1 |
               Eating_C == 1 & Somatic_D ==1, 1, 0)),
    Co_Somatic =  as.factor(
      ifelse(Somatic_C == 1 & Mood_D == 1 |
               Somatic_C == 1 & BPD_P == 1 |
               Somatic_C == 1 & Substance_D == 1 |
               Somatic_C == 1 & Trauma_D == 1 |
               Somatic_C == 1 & Eating_D ==1 |
               Somatic_C == 1 & Anxiety_D ==1 |
               Somatic_C == 1 & Substance_D ==1 |
               Somatic_C == 1 & Psychotic_D ==1, 1, 0)),
    Co_Substance = as.factor(
      ifelse(Substance_C == 1 & Mood_D == 1 |
               Substance_C == 1 & BPD_P == 1 |
               Substance_C == 1 & Substance_D == 1 |
               Substance_C == 1 & Trauma_D == 1 |
               Substance_C == 1 & Eating_D ==1 |
               Substance_C == 1 & Anxiety_D ==1 |
               Substance_C == 1 & Somatic_D ==1 |
               Substance_C == 1 & Psychotic_D ==1, 1, 0)),
    Co_Trauma = as.factor(
      ifelse(Trauma_C == 1 & Mood_D == 1 |
               Trauma_C == 1 & BPD_P == 1 |
               Trauma_C == 1 & Substance_D == 1 |
               Trauma_C == 1 & Eating_D ==1 |
               Trauma_C == 1 & Anxiety_D ==1 |
               Trauma_C == 1 & Somatic_D ==1 |
               Trauma_C == 1 & Psychotic_D ==1, 1, 0)),
    Co_Other = as.factor(
      ifelse(
        Co_Substance == 1 |
        Co_Somatic == 1 |
        Co_Eating == 1 |
        Co_Psychotic == 1, 1, 0))
      )

##### df for plots 

# only include people that attend treatment & its thier first time attending
Mothership <- Mothership |>
  filter(
    is.na(Prev_AdmitID_1),
    C_Admit_1 == 1
  ) |>
  mutate(
    dummy = -99
  ) |>
  filter(!is.na(Disorder_treat),
         !is.na(TxYear),
         !is.na(Duration))

# df without NAs in date and disorder type

Mothership_Diag_treat <- Mothership |>
  filter(!is.na(Disorder_treat),
         !is.na(TxYear),
         !is.na(Duration))

### Export as CSV
write.csv(Mothership,"~/Desktop/Coding/data/Mothership_Diag_treat.csv")

# 3. Functions to create Pre - post scores -----------------------------------

#1. load DF
  Mothership_post <- Mothership

  # Depression
    CUDOS_Score_post <-  select(Mothership_post, dummy,Day1_CUDOS:Day40_CUDOS)
  # Anxiety
    CUXOS_Score_post <- select(Mothership_post, dummy,Day1_CUXOS:Day40_CUXOS)

#2. Getting post scores for people who have NA for post

  # Depression
    Post_DEP <- NA
    PD_df <- NA
    for(i in 1:nrow(CUDOS_Score_post)){
      PD_df <- unname(unlist(CUDOS_Score_post[i,]))
      PD_df <- PD_df[!is.na(PD_df)]
      PD_df <- tail(PD_df, n=1)
      Post_DEP <- rbind(Post_DEP,PD_df)
    }
    Post_Dep <- Post_DEP[-1]

  # Anxiety
    Post_ANX <- NA
    PA_df <- NA
    for(i in 1:nrow(CUXOS_Score_post)){
      PA_df <- unname(unlist(CUXOS_Score_post[i,]))
      PA_df <- PA_df[!is.na(PA_df)]
      PA_df <- tail(PA_df, n=1)
      Post_ANX <- rbind(Post_ANX,PA_df)
    }
    Post_anx <- Post_ANX[-1]

# 3. Getting BL scores for people who have NA at Baseline 

  # Depression / Anxiety Dummy variable
    CUDOS_Score_pre <-  select(Mothership_post, Day1_CUDOS:Day40_CUDOS,dummy)
    CUXOS_Score_pre <- select(Mothership_post, Day1_CUXOS:Day40_CUXOS,dummy)
  
  # Depression
    Pre_DEP <- NA
    PD_df <- NA
    for(i in 1:nrow(CUDOS_Score_pre)){
      PD_df <- unname(unlist(CUDOS_Score_pre[i,]))
      PD_df <- PD_df[!is.na(PD_df)]
      PD_df <- head(PD_df, n=1)
      Pre_DEP <- rbind(Pre_DEP,PD_df)
    }
    Pre_dep <- Pre_DEP[-1]
    
  # Anxiety
    Pre_ANX <- NA
    PA_df <- NA
    for(i in 1:nrow(CUXOS_Score_pre)){
      PA_df <- unname(unlist(CUXOS_Score_pre[i,]))
      PA_df <- PA_df[!is.na(PA_df)]
      PA_df <- head(PA_df, n=1)
      Pre_ANX <- rbind(Pre_ANX,PA_df)
    }
    Pre_anx <- Pre_ANX[-1]

#4 Adding it back to mother ship
    Mothership_post <- Mothership_post |>
      mutate(
        CUDOS_first = ifelse(is.na(BL_CUDOS),Pre_dep,BL_CUDOS),
        CUDOS_first = ifelse(CUDOS_first < 0, NA, CUDOS_first),
        CUXOS_first = ifelse(is.na(BL_CUXOS),Pre_anx,BL_CUXOS),
        CUXOS_first = ifelse(CUXOS_first < 0, NA, CUXOS_first),
        CUDOS_pre = BL_CUDOS,
        CUXOS_pre = BL_CUXOS,
        CUDOS_post = ifelse(!is.na(SUMdep_DC), SUMdep_DC,Post_Dep),
        CUDOS_post = ifelse(CUDOS_post < 0, NA, CUDOS_post),
        CUXOS_post = ifelse(!is.na(SUManx_DC), SUManx_DC,Post_anx),
        CUXOS_post = ifelse(CUXOS_post < 0, NA, CUXOS_post),
#5 Making some other varaibles
        BL_Missing = as.factor(ifelse(is.na(BL_CUXOS), "Anx Missing",
                                      ifelse(is.na(BL_CUDOS), "Dep Missing", "Not Missing"
                                      ))),
        Sig_BL = as.factor(ifelse(BL_CUXOS > 20 & BL_CUDOS > 20, "Sig Both",
                                  ifelse(BL_CUXOS > 20, "Sig Anx",
                                         ifelse(BL_CUDOS > 20, "Sig Dep",
                                                ifelse(is.na(BL_CUXOS),NA,
                                                       ifelse(is.na(BL_CUDOS),NA, "Sub Both"
                                                       )))))),
        Sig_BL_Anx = as.factor(ifelse(BL_CUXOS > 20, "Significant",
                                      ifelse(is.na(BL_CUXOS),NA, "Subclinical"
                                      ))),
        Sig_BL_Dep = as.factor(ifelse(BL_CUDOS > 20, "Significant",
                                      ifelse(is.na(BL_CUDOS),NA, "Subclinical"
                                      ))),
        Sig_Post_Anx = as.factor(ifelse(CUXOS_post > 20, "Significant",
                                        ifelse(is.na(CUXOS_post),NA, "Subclinical"
                                        ))),
        Sig_Post_Dep = as.factor(ifelse(CUDOS_post > 20, "Significant",
                                        ifelse(is.na(CUDOS_post),NA, "Subclinical"
                                        ))),
        Any_Sig_BL = as.factor(ifelse(BL_CUXOS > 20 | BL_CUDOS > 20, "Sig",
                                      ifelse(is.na(BL_CUXOS),NA,
                                             ifelse(is.na(BL_CUDOS),NA, "Sub"
                                             )))),
        Sig_BL = as.factor(ifelse(BL_CUXOS > 20 & BL_CUDOS > 20, "Sig Both",
                                  ifelse(BL_CUXOS > 20, "Sig Anx",
                                         ifelse(BL_CUDOS > 20, "Sig Dep",
                                                ifelse(is.na(BL_CUDOS), NA,
                                                       ifelse(is.na(BL_CUXOS), NA, "Subclinical"
                                                       ))))))
)



# 4. RCI Analysis categorization ------------------------------------------


#devtools::install_github("AWKruijt/JT-RCI")

library(JTRCI)
citation("JTRCI")

# 
# #devtools::install_github("zieglema/ClinicalSig")
#1. Create df for RCI
RCI_df_dep <- Mothership_post |>
  mutate(
    ID1  = as.integer(ID1),
    pre  = as.numeric(CUDOS_pre),
    post = as.numeric(CUDOS_post),
  ) |>
  select(
    ID1,pre,post
  ) |>
  filter(!is.na(pre),
         !is.na(post),
         pre > 20)

RCI_df_anx <- Mothership_post |>
  mutate(
    ID1  = as.integer(ID1),
    pre  = as.numeric(CUXOS_pre),
    post = as.numeric(CUXOS_post),
  ) |>
  select(
    ID1,pre,post
  ) |>
  filter(!is.na(pre),
         !is.na(post),
         pre > 20)


RCI_df_dep <- data.frame(RCI_df_dep)
RCI_df_anx <- data.frame(RCI_df_anx)

# https://awkruijt.netlify.app/plotposts/longitudinaljtrci

RCI_df_anx1<-RCI_df_anx |>
  select(ID1,pre,post)

## Using RCI only (respond/nonrespond/deteriorated)
DEP_RCI <- JTRCI (data = RCI_df_dep, 
                  pre = "pre", 
                  post = "post", 
                  ppid = "ID1", 
                  reliability = .74, 
                  indextype = "RCI", 
                  JTcrit = "auto",
                  plottitle = "JT indices for anxiety")

ANX_RCI <- JTRCI (data = RCI_df_anx, 
                  pre = "pre", 
                  post = "post", 
                  ppid = "ID1", 
                  reliability = .74, 
                  indextype = "RCI", 
                  #JTcrit = "auto",
                  plottitle = "JT indices for depression")
RCI_DF<- ANX_RCI$data
colnames(RCI_DF) <- paste0(colnames(RCI_DF),"_anx")

RCI_DF2<- DEP_RCI$data
colnames(RCI_DF2) <- paste0(colnames(RCI_DF2),"_dep")

RCI_DF <- full_join(RCI_DF,RCI_DF2, by = c("ppid_anx" = "ppid_dep"))
colnames(RCI_DF)[1] = "ID1"

head(RCI_DF)
```


```{r}
#Using JT citeria (recovered/improved/nonresponse/deteriorated)

#1. JT classification for depression
JTRCI (data = RCI_df_dep, 
                  pre = "pre", 
                  post = "post", 
                  ppid = "ID1", 
                  reliability = .74, 
                  indextype = "JT", 
                  JTcrit = "auto",
                  plottitle = "JT indices for anxiety")

DEP_JT <- JTRCIdf
colnames(DEP_JT) <- paste0(colnames(DEP_JT),"_dep")
head(DEP_JT)

#2. JT classification for anxiety
JTRCI (data = RCI_df_anx, 
                  pre = "pre", 
                  post = "post", 
                  ppid = "ID1", 
                  reliability = .74, 
                  indextype = "JT", 
                  #JTcrit = "auto",
                  plottitle = "JT indices for depression")

ANX_JT<- JTRCIdf

#3. Make combined JT table for anxiety and depression

# JT_DF<- ANX_JT

colnames(ANX_JT) <- paste0(colnames(ANX_JT),"_anx")

# 
# JT_DF2<- DEP_JT

# 
# JT_DF <- full_join(JT_DF,JT_DF2, by = c("ppid_anx" = "ppid_dep"))
# colnames(JT_DF)[1] = "ID1"

head(ANX_JT)
```


JTRCI with less people
```{r}

Mothership_lasso <- Mothership_post |>
  filter(
  !is.na(Some_College),
  !is.na(Female),
  !is.na(IPT_track_1),
  !is.na(White),
  #!is.na(Anxiety_Responder),
  ) |>
  select( c(
    ID1,Disorder_treat,
    # Demographics
    Age_1,Some_College:Married,White, #Discharge,
    # Treatment info
    IPT_track_1, Days_complete_1, Days_not_attended_1, #Days_cancel_1,
    # Disorders
    Anxiety_D, Mood_D, BPD_P, Trauma_D, Other,
    Anxiety_C, Mood_C, BPD_Co_C, Trauma_C, Substance_C, Other_C, No_Co,
    Current_Dx,
    # Pre-Post stuff
    CUDOS_pre,CUXOS_pre, #CUDOS_first,CUXOS_first
    # RDQ
    rdqPOST_coping:rdqPOST_wbs,
    #For table 3 - RCI info
    CUXOS_pre, CUXOS_post, CUDOS_pre, CUDOS_post,
  ))
Mothership_lasso_1 <- na.omit(Mothership_lasso)

RCI_df_anx2 <- Mothership_lasso_1 |>
  filter(
    !is.na(CUXOS_pre),
    !is.na(CUXOS_post),
    CUXOS_pre > 20,
  )|>
  mutate(
    ID1  = as.integer(ID1),
    pre  = as.numeric(CUXOS_pre),
    post = as.numeric(CUXOS_post),
  ) |>
  select(
    ID1,pre,post
  ) |>
  filter(!is.na(pre),
         !is.na(post),
         pre > 20)

RCI_df_dep2 <- Mothership_lasso_1 |>
  filter(
    !is.na(CUDOS_pre),
    !is.na(CUDOS_post),
    CUDOS_pre > 20,
  ) |>
  mutate(
    ID1  = as.integer(ID1),
    pre  = as.numeric(CUDOS_pre),
    post = as.numeric(CUDOS_post),
  ) |>
  select(
    ID1,pre,post
  ) |>
  filter(!is.na(pre),
         !is.na(post),
         pre > 20)

RCI_df_dep2 <- data.frame(RCI_df_dep2)
RCI_df_anx2 <- data.frame(RCI_df_anx2)

#1. JT classification for depression
JTRCI (data = RCI_df_dep2, 
                  pre = "pre", 
                  post = "post", 
                  ppid = "ID1", 
                  reliability = .74, 
                  indextype = "JT", 
                  JTcrit = "auto",
                  plottitle = "JT indices for Depression")

DEP_JT_smol <- JTRCIdf
colnames(DEP_JT_smol) <- paste0(colnames(DEP_JT_smol),"_dep")
head(DEP_JT_smol)

#2. JT classification for anxiety
JTRCI (data = RCI_df_anx2, 
                  pre = "pre", 
                  post = "post", 
                  ppid = "ID1", 
                  reliability = .74, 
                  indextype = "JT", 
                  #JTcrit = "auto",
                  plottitle = "JT Indices For Anxiety")

ANX_JT_smol<- JTRCIdf

colnames(ANX_JT_smol) <- paste0(colnames(ANX_JT_smol),"_anx")

view(ANX_JT_smol)
view(DEP_JT_smol)
```


```{r}
###############          Adding RCI to dataset       ####################

Mothership_post <- Mothership_post |>
  #1. Filter out scores for people not in the program / don't have data
  filter(!is.na(Days_complete_1)) |>
  #Having people in the program for more than 40 days means that their scores may be a lot higher, they should be filtered out as result. 
  filter(!is.na(CUXOS_pre),
         !is.na(CUXOS_post),
         CUXOS_pre > 0,
         CUXOS_post >= 0,
         !is.na(CUDOS_pre),
         !is.na(CUDOS_post),
         CUDOS_pre > 0,
         CUDOS_post> 0
         ) |>
  mutate(
    Delta_Anx_DC =  CUXOS_post - CUXOS_pre,
    Delta_Dep_DC = CUDOS_post - CUDOS_pre,
    Percent_Anx_change = (Delta_Anx_DC/CUXOS_pre)*100,
    Percent_Dep_Dchange = (Delta_Dep_DC/CUDOS_pre)*100
  )
    #Days_complete_W = ifelse(Days_complete_1 > 40, 40, Days_complete_1),
    # Anx_Responder = as.factor(
    #   ifelse(CUXOS_pre <= 20 & Percent_Anx_change  <= -50, "Responder",
    #   ifelse(CUXOS_pre <= 20 & Percent_Anx_change  > -50,  "Unresponders", NA)   
    #   )),
    # Dep_Responder = as.factor(
    #   ifelse(CUDOS_pre <= 20 & Percent_Dep_Dchange <= -50, "Responder",
    #   ifelse(CUDOS_pre <= 20 & Percent_Dep_Dchange > -50,   "Unresponders", NA) 
    #   )),
    # Treatment_Responder = as.factor(
    #   ifelse(CUXOS_pre > 10 & CUXOS_pre > 10 & Percent_Anx_change  <= -50 & Percent_Anx_change < 0 & Percent_Dep_Dchange < 0 & Percent_Dep_Dchange <= -50, "Both_Responder", 
    #   ifelse(CUXOS_pre > 10 & Percent_Anx_change  <= -50, "Anx Responder",
    #   ifelse(CUDOS_pre > 10 & Percent_Dep_Dchange <= -50, "Dep Responder",
    #   ifelse(CUDOS_pre > 10 & Percent_Dep_Dchange > 0 & CUXOS_pre > 10 & Percent_Anx_change > 0, "Both Worse",
    #   ifelse(CUXOS_pre > 10 & Percent_Anx_change > 0, "Anx Worse",
    #   ifelse(CUDOS_pre > 10 & Percent_Dep_Dchange > 0, "Dep Worse",
    #   ifelse(CUXOS_pre > 10 & CUDOS_pre > 10 & Percent_Anx_change < 0 & Percent_Anx_change > -50 & Percent_Dep_Dchange < 0 & Percent_Dep_Dchange > -50, "Both Unresponder",
    #   ifelse(CUDOS_pre > 10 & Percent_Dep_Dchange < 0 & Percent_Dep_Dchange > -50, "Dep Unresponders", 
    #   ifelse(CUXOS_pre > 10 & Percent_Anx_change < 0 & Percent_Anx_change > -50, "Anx Unresponders", "Low Baseline"
      # )))))))))))



#2. Left join data from the RCI dataset into the Mothership_post df
# Mothership_post <- left_join(Mothership_post,RCI_DF, by = join_by(ID1 == ID1)) |>
#   mutate(
#     Depression_Responder = ifelse(!is.na(class_RCI_dep), class_RCI_dep, NA),
#     Depression_Responder = as.factor(recode(Depression_Responder,
#                                             "1" = "2",
#                                             "2" = "2",
#                                             "3" = "1"
#     )),
#     Depression_Responder = as.factor(ifelse(!is.na(Depression_Responder), Depression_Responder, Dep_Responder)),
#     Depression_Responder = as.factor(recode(Depression_Responder,
#                                             "2" = "Non-Responder",
#                                             "1" = "Responder"
#     )),
#     Anxiety_Responder = ifelse(!is.na(class_RCI_anx), class_RCI_anx, NA),
#     Anxiety_Responder = as.factor(recode(Anxiety_Responder,
#                                          "1" = "2",
#                                          "2" = "2",
#                                          "3" = "1"
#     )),
#     Anxiety_Responder = as.factor(ifelse(!is.na(Anxiety_Responder), Anxiety_Responder, Anx_Responder)),
#     Anxiety_Responder = as.factor(recode(Anxiety_Responder,
#                                          "2" = "Non-Responder",
#                                          "1" = "Responder"
#     )),
#     RESPONDER_FIGS = as.factor(
#       ifelse(Anxiety_Responder == "Responder" | Depression_Responder == "Responder", "Responder",
#              ifelse(Anxiety_Responder == "Non-Responder" & Depression_Responder == "Non-Responder", "Non-Responder", NA)
#       ))) |>
#   filter(!is.na(RESPONDER_FIGS))
```

JT Numbers
```{r}
Mothership_post_anx <- left_join(Mothership_post,ANX_JT_smol, by = join_by(ID1 == ppid_anx)) |>
  mutate(
    Anxiety_Responder = ifelse(!is.na(class_JTRCI_anx), class_JTRCI_anx, NA),
    Anxiety_Responder = as.factor(recode(Anxiety_Responder,
                                         "1" = "2",
                                         "2" = "2",
                                         "3" = "1",
                                         "4" = "1",
                                         "5" = "1"
    )),
    # Anxiety_Responder = as.factor(ifelse(!is.na(Anxiety_Responder), Anxiety_Responder, NA)),
    Anxiety_Responder = as.factor(recode(Anxiety_Responder,
                                         "2" = "Non-Responder",
                                         "1" = "Responder"
    ))) |>
  filter(
    !is.na(Anxiety_Responder),
    )



Mothership_post_dep <- left_join(Mothership_post,DEP_JT_smol, by = join_by(ID1 == ppid_dep)) |>
  mutate(
    Depression_Responder = ifelse(!is.na(class_JTRCI_dep), class_JTRCI_dep, NA),
    Depression_Responder = as.factor(recode(Depression_Responder,
                                            "1" = "2",
                                            "2" = "2",
                                            "3" = "1",
                                            "4" = "1",
                                            "5" = "1"
    )),
    # Depression_Responder = as.factor(ifelse(!is.na(Depression_Responder), Depression_Responder, NA)),
    Depression_Responder = as.factor(recode(Depression_Responder,
                                            "2" = "Non-Responder",
                                            "1" = "Responder"
    ))) |>
  filter(
    !is.na(Depression_Responder)
    )

Mothership_post_joined <- full_join(Mothership_post_dep,Mothership_post_anx, by = join_by(ID1 == ID1), suffix = c(".x",".y")) |>
  select(-ends_with(".y"))


#It saves everything colname.x, so I'm going to remove the .x from everything
names.x <- colnames(Mothership_post_joined)[2:248]
colnames(Mothership_post_joined)[2:248] <- substr(names.x,1,nchar(names.x)-2)
```

RCI numbers
```{r}
# Mothership_post <- left_join(Mothership_post,RCI_DF, by = join_by(ID1 == ID1)) |>
#   mutate(
#     Depression_Responder = ifelse(!is.na(class_RCI_dep), class_RCI_dep, NA),
#     Depression_Responder = as.factor(recode(Depression_Responder,
#                                             "1" = "2",
#                                             "2" = "2",
#                                             "3" = "1",
#                                             "4" = "1",
#                                             "5" = "1"
#     )),
#     Depression_Responder = as.factor(ifelse(!is.na(Depression_Responder), Depression_Responder, Dep_Responder)),
#     Depression_Responder = as.factor(recode(Depression_Responder,
#                                             "2" = "Non-Responder",
#                                             "1" = "Responder"
#     )),
#     Anxiety_Responder = ifelse(!is.na(class_RCI_anx), class_RCI_anx, NA),
#     Anxiety_Responder = as.factor(recode(Anxiety_Responder,
#                                          "1" = "2",
#                                          "2" = "2",
#                                          "3" = "1",
#                                          "4" = "1",
#                                          "5" = "1"
#     )),
#     Anxiety_Responder = as.factor(ifelse(!is.na(Anxiety_Responder), Anxiety_Responder, Anx_Responder)),
#     Anxiety_Responder = as.factor(recode(Anxiety_Responder,
#                                          "2" = "Non-Responder",
#                                          "1" = "Responder"
#     ))) |>
#   filter(
#     !is.na(Anxiety_Responder),
#     !is.na(Depression_Responder)
#     )
```




# Data analysis 
## Part 1: Methods information
```{r}
summary(as.factor(Mothership_post_joined$SCID_1))
```



## Part 2: Who is attending?

### Demographics information
- Table 1 Demographics By Response
- Table 2: Treatment information - What did treatment look like?
- Table 3: Scores on measures pre post change? 
    + I want to show the figure of pre-post change???
- Table 4: demographic breakdown


First greate dfs for analyses

```{r}
### Anxeity 
Mothership_lasso_anx <- Mothership_post_anx |>
  filter(
  !is.na(Some_College),
  !is.na(Female),
  !is.na(IPT_track_1),
  !is.na(White),
  !is.na(Anxiety_Responder),
  CUXOS_pre >= 20,
  ) |>
  select( c(
    ID1,Anxiety_Responder,Disorder_treat,
    # Demographics
    Age_1,Some_College:Married,White, #Discharge,
    # Treatment info
    IPT_track_1, Days_complete_1, Days_not_attended_1, #Days_cancel_1,
    # Disorders
    Anxiety_D, Mood_D, BPD_P, Trauma_D, Other,
    Anxiety_C, Mood_C, BPD_Co_C, Trauma_C, Substance_C, Other_C, No_Co,
    Current_Dx,
    # Pre-Post stuff
    CUDOS_pre,CUXOS_pre, #CUDOS_first,CUXOS_first
    # RDQ
    rdqPOST_coping:rdqPOST_wbs,
    #For table 3 - RCI info
    CUXOS_pre, CUXOS_post, Delta_Anx_DC, CUDOS_pre, CUDOS_post, Delta_Dep_DC
  ))
Mothership_lasso_anx <- na.omit(Mothership_lasso_anx)

### depression
Mothership_lasso_dep <- Mothership_post_dep |>
    filter(
    !is.na(Some_College),
    !is.na(Female),
    !is.na(IPT_track_1),
    !is.na(White),
    !is.na(Depression_Responder),
    CUDOS_pre >= 20,
  ) |>
  select( c(
    ID1, Depression_Responder,Disorder_treat,
    # Demographics
    Age_1,Some_College:Married,White, #Discharge,
    # Treatment info
    IPT_track_1, Days_complete_1, Days_not_attended_1, #Days_cancel_1,
    # Disorders
    Anxiety_D, Mood_D, BPD_P, Trauma_D, Other,
    Anxiety_C, Mood_C, BPD_Co_C, Trauma_C, Substance_C, Other_C, No_Co,
    Current_Dx,
    # Pre-Post stuff
    CUDOS_pre,CUXOS_pre, #CUDOS_first,CUXOS_first
    # RDQ
    rdqPOST_coping:rdqPOST_wbs,
    #For table 3 - RCI info
    CUXOS_pre, CUXOS_post, Delta_Anx_DC, CUDOS_pre, CUDOS_post, Delta_Dep_DC
  ))
Mothership_lasso_dep <- na.omit(Mothership_lasso_dep)

### joined df
Mothership_lasso_joined <- full_join(Mothership_lasso_anx,Mothership_lasso_dep, by = join_by("ID1" == "ID1")) |> 
    select(-ends_with(".y"))

#It saves everything colname.x, so I'm going to remove the .x from everything
names.x <- colnames(Mothership_lasso_joined)[3:34]
colnames(Mothership_lasso_joined)[3:34] <- substr(names.x,1,nchar(names.x)-2)

#Delete ID1 from dfs
Mothership_lasso_anx <- Mothership_lasso_anx[,-1]
Mothership_lasso_dep <- Mothership_lasso_dep[,-1]
```

```{r}

library(tableone) # This can be used to grab Exporatory data analysis values

### first gather information based upon anxiety
## Vector of variables to summarize
table1_vars_anx <- c(colnames(Mothership_lasso_anx)[-1:-2])
table1_vars_anx <- table1_vars_anx[1:27]


## Vector of categorical variables that need transformation
catVars <- c("Some_College", "Female" , "Married", "White",
             "IPT_track_1","Anxiety_D", "Mood_D", "BPD_P" ,"Trauma_D","Other", 
             "Anxiety_C", "Mood_C" , "BPD_Co_C", "Trauma_C", 
             "Substance_C", "Other_C" , "No_Co"
             )

## Create a TableOne object
table1_tab_anx <- CreateTableOne(vars = table1_vars_anx, data = Mothership_lasso_anx,strata ="Anxiety_Responder",  factorVars = catVars, addOverall = T)
table1_tab_anx <- print(table1_tab_anx, formatOptions = list(big.mark = ","))
table1_tab_anx <- data.frame(table1_tab_anx)
table1_tab_anx
# add discriptive statistics 
table1_tab_anx$ef_size = c("")

library(rstatix)

# age
table1_tab_anx[2,5] <- round(t_test(Age_1 ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[2,6] <- round(cohens_d(Age_1 ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
# Some College 
table1_tab_anx[3,5] <- round(chisq.test(Mothership_lasso_anx$Some_College, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[3,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Some_College))$estimate,2)
# Female
table1_tab_anx[4,5] <- round(chisq.test(Mothership_lasso_anx$Female, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[4,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Female))$estimate,2)
# Married
table1_tab_anx[5,5] <- round(chisq.test(Mothership_lasso_anx$Married, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[5,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Married))$estimate,2)
# White
table1_tab_anx[6,5] <- round(chisq.test(Mothership_lasso_anx$White, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[6,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$White))$estimate,2)
# Treatment track
table1_tab_anx[7,5] <- round(chisq.test(Mothership_lasso_anx$IPT_track_1, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
OR_IPT_anx <- table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$IPT_track_1)
# OR general vs Trauma track
table1_tab_anx[9,6] <- round(fisher.test(cbind(OR_IPT_anx[,"General"],OR_IPT_anx[,"Trauma"]))$estimate,2)
table1_tab_anx[9,5] <-
round(fisher.test(cbind(OR_IPT_anx[,"General"],OR_IPT_anx[,"Trauma"]))$p,2)
# OR General vs Young adult track 
table1_tab_anx[10,6] <- 
  round(fisher.test(cbind(OR_IPT_anx[,"General"],OR_IPT_anx[,"Young Adult"]))$estimate,2)
table1_tab_anx[10,5] <-
round(fisher.test(cbind(OR_IPT_anx[,"General"],OR_IPT_anx[,"Young Adult"]))$p,2)
# Days Completed in program
table1_tab_anx[11,5] <- round(t_test(Days_complete_1 ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[11,6] <- round(cohens_d(Days_complete_1 ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
# Days not attending treatment
table1_tab_anx[12,5] <- round(t_test(Days_not_attended_1 ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[12,6] <- round(cohens_d(Days_not_attended_1 ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
# Anxiety disorder
table1_tab_anx[13,5] <- round(chisq.test(Mothership_lasso_anx$Anxiety_D, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[13,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Anxiety_D))$estimate,2)
# Mood Disorders
table1_tab_anx[14,5] <- round(chisq.test(Mothership_lasso_anx$Mood_D, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[14,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Mood_D))$estimate,2)
# BPD 
table1_tab_anx[15,5] <- round(chisq.test(Mothership_lasso_anx$BPD_P, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[15,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$BPD_P))$estimate,2)
# Truama Related Disorders
table1_tab_anx[16,5] <- round(chisq.test(Mothership_lasso_anx$Trauma_D, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[16,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Trauma_D))$estimate,2)
# Other Disorders
table1_tab_anx[17,5] <- round(chisq.test(Mothership_lasso_anx$Other, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[17,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Other))$estimate,2)
# Co-occurring anxiety disorder 
table1_tab_anx[18,5] <- round(chisq.test(Mothership_lasso_anx$Anxiety_C, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[18,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Anxiety_C))$estimate,2)
# Co-occurring mood disorder
table1_tab_anx[19,5] <- round(chisq.test(Mothership_lasso_anx$Mood_C, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[19,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Mood_C))$estimate,2)
# Co-occurring BPD
table1_tab_anx[20,5] <- round(chisq.test(Mothership_lasso_anx$BPD_Co_C, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[20,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$BPD_Co_C))$estimate,2)
# Co-occurring Trauma Related Disorder
table1_tab_anx[21,5] <- round(chisq.test(Mothership_lasso_anx$Trauma_C, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[21,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Trauma_C))$estimate,2)
# Co-occurring Substance Use Disorders
table1_tab_anx[22,5] <- round(chisq.test(Mothership_lasso_anx$Substance_C, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[22,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Substance_C))$estimate,2)
# Co-occurring Other Disroders
table1_tab_anx[23,5] <- round(chisq.test(Mothership_lasso_anx$Other_C, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[23,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$Other_C))$estimate,2)
# No Co-occurring Disorders
table1_tab_anx[24,5] <- round(chisq.test(Mothership_lasso_anx$No_Co, Mothership_lasso_anx$Anxiety_Responder)$statistic,2)
table1_tab_anx[24,6] <- round(fisher.test(table(Mothership_lasso_anx$Anxiety_Responder,Mothership_lasso_anx$No_Co))$estimate,2)
# Number of Current diagnoses 
table1_tab_anx[25,5] <- round(t_test(Current_Dx ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[25,6] <- round(cohens_d(Current_Dx ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
# CUDOS Pre scores
table1_tab_anx[26,5] <- round(t_test(CUDOS_pre ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[26,6] <- round(cohens_d(CUDOS_pre ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
# CUXOS Pre scores
table1_tab_anx[27,5] <- round(t_test(CUXOS_pre ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[27,6] <- round(cohens_d(CUXOS_pre ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
# RDQ Coping post scores
table1_tab_anx[28,5] <- round(t_test(rdqPOST_coping ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[28,6] <- round(cohens_d(rdqPOST_coping ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
# RDQ Positive Mental Health post scores
table1_tab_anx[29,5] <- round(t_test(rdqPOST_pmh ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[29,6] <- round(cohens_d(rdqPOST_pmh ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
# RDQ Functioning post scores
table1_tab_anx[30,5] <- round(t_test(rdqPOST_func ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[30,6] <- round(cohens_d(rdqPOST_func ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
# RDQ Sense of Wellbeing post scores
table1_tab_anx[31,5] <- round(t_test(rdqPOST_wbs ~ Anxiety_Responder, data = Mothership_lasso_anx)$statistic,2)
table1_tab_anx[31,6] <- round(cohens_d(rdqPOST_wbs ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)

table1_tab_anx[,2:7] <- table1_tab_anx
table1_tab_anx[,1] <- rownames(table1_tab_anx)
colnames(table1_tab_anx) <- c("Variables",colnames(table1_tab_anx)[1:6])

table1_tab_anx

write_csv(table1_tab_anx,"~/Downloads/table1_tab_anx.csv")
```


```{r}
## Vector of variables to summarize
table1_vars_dep <- c(colnames(Mothership_lasso_dep)[-1:-2])
table1_vars_dep <- table1_vars_dep[1:27]

## Create a TableOne object
table1_tab_dep <- CreateTableOne(vars = table1_vars_dep, data = Mothership_lasso_dep,strata ="Depression_Responder",  factorVars = catVars, addOverall = T)
table1_tab_dep <- print(table1_tab_dep, formatOptions = list(big.mark = ","))
table1_tab_dep <-data.frame(table1_tab_dep)

# add discriptive statistics 
table1_tab_dep$ef_size = c("")

table1_tab_dep

# age
table1_tab_dep[2,5] <- round(t_test(Age_1 ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[2,6] <- round(cohens_d(Age_1 ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
# Some College 
table1_tab_dep[3,5] <- round(chisq.test(Mothership_lasso_dep$Some_College, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[3,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Some_College))$estimate,2)
# Female
table1_tab_dep[4,5] <- round(chisq.test(Mothership_lasso_dep$Female, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[4,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Female))$estimate,2)
# Married
table1_tab_dep[5,5] <- round(chisq.test(Mothership_lasso_dep$Married, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[5,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Married))$estimate,2)
# White
table1_tab_dep[6,5] <- round(chisq.test(Mothership_lasso_dep$White, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[6,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$White))$estimate,2)
# Treatment track
table1_tab_dep[7,5] <- round(chisq.test(Mothership_lasso_dep$IPT_track_1, Mothership_lasso_dep$Depression_Responder)$statistic,2)
OR_IPT_dep <- table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$IPT_track_1)
# OR general vs Trauma track
table1_tab_dep[9,5] <- round(fisher.test(cbind(OR_IPT_dep[,"General"],OR_IPT_dep[,"Trauma"]))$estimate,2)
table1_tab_dep[9,6] <-
round(fisher.test(cbind(OR_IPT_dep[,"General"],OR_IPT_dep[,"Trauma"]))$p,2)
# OR General vs Young adult track 
table1_tab_dep[10,5] <- 
  round(fisher.test(cbind(OR_IPT_dep[,"General"],OR_IPT_dep[,"Young Adult"]))$estimate,2)
table1_tab_dep[10,6] <-
round(fisher.test(cbind(OR_IPT_dep[,"General"],OR_IPT_dep[,"Young Adult"]))$p,2)
# Days Completed in program
table1_tab_dep[11,5] <- round(t_test(Days_complete_1 ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[11,6] <- round(cohens_d(Days_complete_1 ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
# Days not attending treatment
table1_tab_dep[12,5] <- round(t_test(Days_not_attended_1 ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[12,6] <- round(cohens_d(Days_not_attended_1 ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
# Anxiety disorder
table1_tab_dep[13,5] <- round(chisq.test(Mothership_lasso_dep$Anxiety_D, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[13,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Anxiety_D))$estimate,2)
# Mood Disorders
table1_tab_dep[14,5] <- round(chisq.test(Mothership_lasso_dep$Mood_D, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[14,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Mood_D))$estimate,2)
# BPD 
table1_tab_dep[15,5] <- round(chisq.test(Mothership_lasso_dep$BPD_P, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[15,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$BPD_P))$estimate,2)
# Truama Related Disorders
table1_tab_dep[16,5] <- round(chisq.test(Mothership_lasso_dep$Trauma_D, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[16,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Trauma_D))$estimate,2)
# Other Disorders
table1_tab_dep[17,5] <- round(chisq.test(Mothership_lasso_dep$Other, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[17,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Other))$estimate,2)
# Co-occurring anxiety disorder 
table1_tab_dep[18,5] <- round(chisq.test(Mothership_lasso_dep$Anxiety_C, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[18,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Anxiety_C))$estimate,2)
# Co-occurring mood disorder
table1_tab_dep[19,5] <- round(chisq.test(Mothership_lasso_dep$Mood_C, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[19,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Mood_C))$estimate,2)
# Co-occurring BPD
table1_tab_dep[20,5] <- round(chisq.test(Mothership_lasso_dep$BPD_Co_C, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[20,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$BPD_Co_C))$estimate,2)
# Co-occurring Trauma Related Disorder
table1_tab_dep[21,5] <- round(chisq.test(Mothership_lasso_dep$Trauma_C, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[21,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Trauma_C))$estimate,2)
# Co-occurring Substance Use Disorders
table1_tab_dep[22,5] <- round(chisq.test(Mothership_lasso_dep$Substance_C, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[22,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Substance_C))$estimate,2)
# Co-occurring Other Disroders
table1_tab_dep[23,5] <- round(chisq.test(Mothership_lasso_dep$Other_C, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[23,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$Other_C))$estimate,2)
# No Co-occurring Disorders
table1_tab_dep[24,5] <- round(chisq.test(Mothership_lasso_dep$No_Co, Mothership_lasso_dep$Depression_Responder)$statistic,2)
table1_tab_dep[24,6] <- round(fisher.test(table(Mothership_lasso_dep$Depression_Responder,Mothership_lasso_dep$No_Co))$estimate,2)
# Number of Current diagnoses 
table1_tab_dep[25,5] <- round(t_test(Current_Dx ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[25,6] <- round(cohens_d(Current_Dx ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
# CUDOS Pre scores
table1_tab_dep[26,5] <- round(t_test(CUDOS_pre ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[26,6] <- round(cohens_d(CUDOS_pre ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
# CUXOS Pre scores
table1_tab_dep[27,5] <- round(t_test(CUXOS_pre ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[27,6] <- round(cohens_d(CUXOS_pre ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
# RDQ Coping post scores
table1_tab_dep[28,5] <- round(t_test(rdqPOST_coping ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[28,6] <- round(cohens_d(rdqPOST_coping ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
# RDQ Positive Mental Health post scores
table1_tab_dep[29,5] <- round(t_test(rdqPOST_pmh ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[29,6] <- round(cohens_d(rdqPOST_pmh ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
# RDQ Functioning post scores
table1_tab_dep[30,5] <- round(t_test(rdqPOST_func ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[30,6] <- round(cohens_d(rdqPOST_func ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
# RDQ Sense of Wellbeing post scores
table1_tab_dep[31,5] <- round(t_test(rdqPOST_wbs ~ Depression_Responder, data = Mothership_lasso_dep)$statistic,2)
table1_tab_dep[31,6] <- round(cohens_d(rdqPOST_wbs ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)

table1_tab_dep[,2:7] <- table1_tab_dep
table1_tab_dep[,1] <- rownames(table1_tab_dep)
colnames(table1_tab_dep) <- c("Variables",colnames(table1_tab_dep)[1:6])

table1_tab_dep
write_csv(table1_tab_dep,"~/Downloads/table1_tab_dep.csv")

```

Means and SDs of post scores
```{r}

mean(Mothership_lasso_anx$CUXOS_post)
sd(Mothership_lasso_anx$CUXOS_post)

mean(Mothership_lasso_dep$CUDOS_post)
sd(Mothership_lasso_dep$CUDOS_post)

```

### Treatment information
Overal look at treatment varaibles by treatment response
```{r}
# PHP Treatment information
# resp_tab <- data.frame(table1::table1(
#    ~IPT_track_1 + Days_complete_1 + Days_cancel_1 + Days_not_attended_1 + Days_noshow_1 | RESPONDER_FIGS, 
#   data = Mothership_post))
# colnames(resp_tab) <- c("Variable","Non-Responder", "Responder", "Total Sample")
# resp_tab
```

# RCI analysis Table
pre-post scores by treatment response, cut off, and RCI threshold
```{r}
# Treatment scores
#1. Make DF + name columns
Scores_tab <- data.frame(matrix(nrow = 2 ,ncol=9))
colnames(Scores_tab) = c("Instrument", "N_Pre M(SD)", "N_Post M(SD)", "N_Change M(SD)","R_Pre M(SD)", "R_Post M(SD)", "R_Change M(SD)", "Cut Off", "RCI")

#2. Row 1 - responders
Scores_tab[1,] = c(NA,"M (sd)","M (sd)","M (sd)","M (sd)","M (sd)","M (sd)",NA,NA)

#3. Get statistics for variables + Assign to table
  # Anxiety - CUXOS
    #make df
      anx_rep_tab <- Mothership_lasso_anx |>
        group_by(Anxiety_Responder) |>
        summarize(pre_anx = round(mean(CUXOS_pre, na.rm = TRUE),2),
                  pre_anx_sd = round(sd(CUXOS_pre, na.rm = TRUE),2),
                  post_anx = round( mean(CUXOS_post,na.rm = TRUE),2),
                  post_anx_sd = round( sd(CUXOS_post,na.rm = TRUE),2),
                  delta_anx = round( mean(Delta_Anx_DC,na.rm = TRUE),2),
                  delta_anx_sd = round( sd(Delta_Anx_DC, na.rm = TRUE),2)
                  )
# add to scores tab
        Scores_tab[2,] = c(
          "CUXOS",
          #Non-responder scores
          paste0(anx_rep_tab$pre_anx[[2]]," (",anx_rep_tab$pre_anx_sd[[2]],")"),
          paste0(anx_rep_tab$post_anx[[2]]," (",anx_rep_tab$post_anx_sd[[2]],")"),
          paste0(anx_rep_tab$delta_anx[[2]]," (",anx_rep_tab$delta_anx_sd[[2]],")"),
          #responder scores
          paste0(anx_rep_tab$pre_anx[[1]]," (",anx_rep_tab$pre_anx_sd[[1]],")"),
          paste0(anx_rep_tab$post_anx[[1]]," (",anx_rep_tab$post_anx_sd[[1]],")"),
          paste0(anx_rep_tab$delta_anx[[1]]," (",anx_rep_tab$delta_anx_sd[[1]],")"),
          20,
          20
        )
        
# Depression - CUDOS
  #Make df
    dep_rep_tab <- Mothership_lasso_dep |>
      group_by(Depression_Responder) |>
      summarize(pre_dep = round( mean(CUDOS_pre, na.rm = TRUE),2),
                pre_dep_sd = round( sd(CUDOS_pre, na.rm = TRUE),2),
                post_dep = round( mean(CUDOS_post, na.rm = TRUE),2),
                post_dep_sd = round( sd(CUDOS_post, na.rm = TRUE),2),
                delta_dep = round( mean(Delta_Dep_DC, na.rm = TRUE),2),
                delta_dep_sd = round( sd(Delta_Dep_DC, na.rm = TRUE),2)
                )
    #Add to Scores_tab
       Scores_tab[3,] = c(
        "CUDOS",
        #Non-responder scores
        paste0(dep_rep_tab$pre_dep[[2]]," (",dep_rep_tab$pre_dep_sd[[2]],")"),
        paste0(dep_rep_tab$post_dep[[2]]," (",dep_rep_tab$post_dep_sd[[2]],")"),
        paste0(dep_rep_tab$delta_dep[[2]]," (",dep_rep_tab$delta_dep_sd[[2]],")"),
        #responder scores
        paste0(dep_rep_tab$pre_dep[[1]]," (",dep_rep_tab$pre_dep_sd[[1]],")"),
        paste0(dep_rep_tab$post_dep[[1]]," (",dep_rep_tab$post_dep_sd[[1]],")"),
        paste0(dep_rep_tab$delta_dep[[1]]," (",dep_rep_tab$delta_dep_sd[[1]],")"),
        20,
        13
      )
       
Scores_tab
```
## Part 2: RCI ANALYSIS - Treatment Response
Anxiety & Depression = Total response
- Table 4: RCI Analsyis results
  + Anxiety, Depression, Total response
- Figure 2 / Supplimetal 2: RCI Analysis figs 
  + Anxeity & Depression
  
Table 3
```{r}
# RCI_table

# JT Table
JT_table <- data.frame(matrix(NA,nrow = 3,ncol = 6))
colnames(JT_table) = c("Instrument","Responder","Non-Responder", "Mean Pre Score", "RCI","JT Criterion A")
#discriptor row

JT_table[1,] = c(NA,"n","n", "M (SD)",NA,NA)
summary(Mothership_lasso_anx$Anxiety_Responder)[[1]]

#Anxiety
JT_table[2,] = c("CUXOS", 
                 summary(Mothership_lasso_anx$Anxiety_Responder)[[1]],
                 summary(Mothership_lasso_anx$Anxiety_Responder)[[2]],
                 paste0(round(mean(Mothership_lasso_anx$CUXOS_pre),2), " (", 
                        round(sd(Mothership_lasso_anx$CUXOS_pre),2),")"),
                 13,
                 21)

summary(Mothership_lasso_anx$Anxiety_Responder)[2]

# Depresssion
JT_table[3,] = c("CUDOS", 
                 summary(Mothership_lasso_dep$Depression_Responder)[[1]],             
                 summary(Mothership_lasso_dep$Depression_Responder)[[2]],
                 paste0(round(mean(Mothership_lasso_dep$CUDOS_pre),2), " (", 
                        round(sd(Mothership_lasso_dep$CUDOS_pre),2),")"),
                 21,
                 17)

JT_table
```

###table 4A
Between Group Differences of Anxiety at Pre and Post Timepoints by Anxiety Treatment Response
```{r}
#table set up
tab4 <- data.frame(matrix(NA,nrow = 5,ncol = 5))
colnames(tab4) = c("Instrument","Responder","Non-Responder", "Test Score", "Effect Size")
tab4[1,] = c(NA,"M (SD)", "M (SD)", "t", "d")

#anxiety 

t.test_pre_anx  <- t.test(CUXOS_pre ~ Anxiety_Responder, data = Mothership_lasso_anx)
t.test_post_anx <- t.test(CUXOS_post ~ Anxiety_Responder, data = Mothership_lasso_anx)

t.test_pre_dep  <- t.test(CUDOS_pre ~ Depression_Responder, data = Mothership_lasso_dep)
t.test_post_dep <- t.test(CUDOS_post ~ Depression_Responder, data = Mothership_lasso_dep)

##mean
t.test_pre_anx$estimate[[1]]

t.test_pre_anx$statistic[[1]]

#CUXOS PRE
tab4[2,] = c(
  "CUXOS Pre",
  #Responder
  paste0(round(t.test_pre_anx$estimate[[1]],2)," (",
         round(sd(subset(Mothership_lasso_anx,
                         Anxiety_Responder == "Responder")$CUXOS_pre),2),
         ")"),
  #non-responder
  paste0(round(t.test_pre_anx$estimate[[2]],2)," (",
         round(sd(subset(Mothership_lasso_anx,
                         Anxiety_Responder == "Non-Responder")$CUXOS_pre),2),
         ")"),
  #t-stat
  round(t.test_pre_anx$statistic[[1]],2),
  #effect size
  round(cohens_d(CUXOS_pre ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
    )
  
#CUXOS Post
tab4[3,] = c(
  "CUXOS Post",
  #Responder
  paste0(round(t.test_post_anx$estimate[[1]],2)," (",
         round(sd(subset(Mothership_lasso_anx,
                         Anxiety_Responder == "Responder")$CUXOS_post),2),
         ")"),
  #non-responder
  paste0(round(t.test_post_anx$estimate[[2]],2)," (",
         round(sd(subset(Mothership_lasso_anx,
                         Anxiety_Responder == "Non-Responder")$CUXOS_post),2),
         ")"),
  #t-stat
  round(t.test_post_anx$statistic[[1]],2),
  #effect size
  round(cohens_d(CUXOS_post ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
    )

#CUDOS PRE
tab4[4,] = c(
  "CUDOS Pre",
  #Responder
  paste0(round(t.test_pre_dep$estimate[[1]],2)," (",
         round(sd(subset(Mothership_lasso_dep,
                         Depression_Responder == "Responder")$CUDOS_pre),2),
         ")"),
  #non-responder
  paste0(round(t.test_pre_dep$estimate[[2]],2)," (",
         round(sd(subset(Mothership_lasso_dep,
                         Depression_Responder == "Non-Responder")$CUDOS_pre),2),
         ")"),
  #t-stat
  round(t.test_pre_dep$statistic[[1]],2),
  #effect size
  round(cohens_d(CUDOS_pre ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
    )
  
#CUDOS Post
tab4[5,] = c(
  "CUDOS Post",
  #Responder
  paste0(round(t.test_post_dep$estimate[[1]],2)," (",
         round(sd(subset(Mothership_lasso_dep,
                         Depression_Responder == "Responder")$CUDOS_post),2),
         ")"),
  #non-responder
  paste0(round(t.test_post_dep$estimate[[2]],2)," (",
         round(sd(subset(Mothership_lasso_dep,
                         Depression_Responder == "Non-Responder")$CUDOS_post),2),
         ")"),
  #t-stat
  round(t.test_post_dep$statistic[[1]],2),
  #effect size
  round(cohens_d(CUDOS_post ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
    )


tab4
```


```{r}
# t test scores for differences pre post, between and within groups. 
Pre_Post_t_Scores <- c("")

#1. Pre post score differences of anxeity and depression by treatment response:
  #1.1 depression responders   
    t.test(subset(Mothership_lasso_dep,Depression_Responder == "Responder")$CUDOS_pre,
       subset(Mothership_lasso_dep,Depression_Responder == "Responder")$CUDOS_post,
       paired = TRUE, alternative = "two.sided"
       )
  #1.2 depression non-responders   
     t.test(subset(Mothership_lasso_dep,Depression_Responder == "Non-Responder")$CUDOS_pre,
       subset(Mothership_lasso_dep,Depression_Responder == "Non-Responder")$CUDOS_post,
       paired = TRUE, alternative = "two.sided"
       )
  #1.3 anxiety responders   
    t.test(subset(Mothership_lasso_anx,Anxiety_Responder == "Responder")$CUXOS_pre,
       subset(Mothership_lasso_anx,Anxiety_Responder == "Responder")$CUXOS_post,
       paired = TRUE, alternative = "two.sided"
       )
  #1.2 anxiety non-responders   
     t.test(subset(Mothership_lasso_anx,Anxiety_Responder == "Non-Responder")$CUXOS_pre,
       subset(Mothership_lasso_anx,Anxiety_Responder == "Non-Responder")$CUXOS_post,
       paired = TRUE, alternative = "two.sided"
       )
#So, Non-responders and responders have lower post scores than pre scores for anxiety and depression.
     
#2. Differences between group differences for pre and post scores of anxiety and depression.
  #2.1 Pre scores of anxiety
     t.test(CUXOS_pre ~ Anxiety_Responder, data = Mothership_lasso_anx)
     round(cohens_d(CUXOS_pre ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
  #2.2 Post scores of anxiety
     t.test(CUXOS_post ~ Anxiety_Responder, data = Mothership_lasso_anx)
     sd(subset(Mothership_lasso_anx,Anxiety_Responder == "Responder")$CUXOS_post)
     sd(subset(Mothership_lasso_anx,Anxiety_Responder == "Non-Responder")$CUXOS_post)
     round(cohens_d(CUXOS_post ~ Anxiety_Responder, data = Mothership_lasso_anx)$effsize,2)
  #2.3 Pre scores of depression
     t.test(CUDOS_pre ~ Depression_Responder, data = Mothership_lasso_dep)
     round(cohens_d(CUDOS_pre ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
  #2.4 Post scores of depression
     t.test(CUDOS_post ~ Depression_Responder, data = Mothership_lasso_dep)
     sd(subset(Mothership_lasso_dep,Depression_Responder == "Responder")$CUDOS_post)
     sd(subset(Mothership_lasso_dep,Depression_Responder == "Non-Responder")$CUDOS_post)
     round(cohens_d(CUDOS_post ~ Depression_Responder, data = Mothership_lasso_dep)$effsize,2)
     

     
  test1  <- t.test(CUXOS_pre ~ Anxiety_Responder, data = Mothership_lasso_anx)
     

test1$estimate[[1]] #responder pre cuxos mean
     
```


```{r}

```


ataset visualizatoin
```{r}
# #install.packages("ggdist")
# library("ggdist")
# 
# Mothership_lasso |> 
#   ggplot( aes(x=Depression_Responder, y=CUDOS_pre, fill=Depression_Responder)) +
#     geom_boxplot() +
#    #viridis::scale_fill_viridis(discrete = TRUE, alpha=0.6) +
#     geom_jitter(color="black", size=.6 , alpha=0.9) +
#     theme(
#       legend.position="none",
#       plot.title = element_text(size=11)
#     ) +
# #    ggtitle("Pre scores of depression severity") +
#     xlab("Depression Severity") +
#     ylim(0,80)
# 
# Mothership_lasso|>
# ggplot( mapping=aes(x=Trauma_C)) +
#   geom_bar()
# 
# Mothership_lasso|>
# ggplot( mapping=aes(x= Current_Dx)) +
#         geom_histogram() +
#     theme(panel.grid.major.y = element_line(color = "grey",size = 0.5,linetype = 2))+
#   theme(panel.background=NULL)+
#   theme(legend.title = element_blank()) 
# 

```


Take away form this is:
1. Non-responders and responders have lower post scores than pre scores for anxiety and depression.
2. There are no statistically significant differences in pre scores of anxiety or depression between responders and non-responders
3. There are significantly lower scores of anxiety and depression between responders and non-responder.


Figure 1: Pre-post Line Plot
```{r}
#1. Create long data frame for pre/post depression
dep_prepost <- dep_rep_tab |>
  pivot_longer(
    cols = c("pre_dep", "post_dep"),
    names_to = "PrePost",
    values_to = "Score"
  ) |>
  select(Depression_Responder,PrePost,Score) |>
  mutate(
    Test = "CUDOS",
    PrePost = ifelse(PrePost == "pre_dep", "Pre", "Post")
  )
colnames(dep_prepost)[1] = "Responder"

#2. Create long data frame for pre/post anxiety
anx_prepost <- anx_rep_tab |>
  pivot_longer(
    cols = c("pre_anx", "post_anx"),
    names_to = "PrePost",
    values_to = "Score"
  ) |>
  select(Anxiety_Responder,PrePost,Score) |>
  mutate(
    Test = "CUXOS",
    PrePost = ifelse(PrePost == "pre_anx", "Pre", "Post"),
  )
colnames(anx_prepost)[1] = "Responder"

anx_prepost

#3. Combine dataset
AnxDep_fig_response <- rbind(dep_prepost,anx_prepost)
  
#4. Plot pre post scores by treatment response
ggplot(data=AnxDep_fig_response,
       aes(x=factor(PrePost,level=c("Pre","Post")),y=Score,
           group=Test,color=fct_rev(Test)))+
  geom_point(size=2.5) +
  geom_line(group=AnxDep_fig_response$PrePost,size=1.5)+
  ### ADD confidience intervals??
  scale_x_discrete(name="Time Point")+
  scale_y_continuous(name="CUDOS/CUXOS Score")+
  ggtitle("Mean Pre and Post Scores of Anxiety and Depression")+
  theme(panel.grid.major.y = element_line(color = "grey",size = 0.5,linetype = 2))+
  theme(panel.background=NULL)+
  theme(legend.title = element_blank()) +
  facet_wrap(~Responder)
```



### Disorder Breakdowns
Here are some tables displaying info on the psychiatric disorders treated at the PHP
```{r}

Mothership_lasso_anx

# # Disorders by treatment response
# Dis_tab <- data.frame(table1::table1(~Disorder_treat + Current_Dx | Anxiety_Responder, 
#                                      data = Mothership_lasso_joined))
# colnames(Dis_tab) = c("Variables","Anxiety Non Responder", "Anxiety Responder", "Total")
# 
# Dis_tab1 <- data.frame(table1::table1(~Disorder_treat + Current_Dx | Depression_Responder, 
#                                      data = Mothership_lasso))
# colnames(Dis_tab1) = c("Variables","Depression Non Responder", "Depression Responder", "Total")
# Dis_tab <- cbind(Dis_tab1[,1:3],Dis_tab[,2:4])
# Dis_tab

#Full demographic break down

co_dis_tab <- Mothership_lasso_joined |>
  pivot_longer(
    cols = c("Anxiety_C","Mood_C","BPD_Co_C","Other_C", "Substance_C","Trauma_C", "No_Co"),
    names_to = 'Co Occuring',
    values_to = "Number"
  ) |>
  select(Disorder_treat, `Co Occuring`, Number) |>
  filter(Number != 0,
         !is.na(`Co Occuring`),
         !is.na(Disorder_treat),
         ) 

CODis_tab<-data.frame(table1::table1(~`Co Occuring` | Disorder_treat, data = co_dis_tab))
colnames(CODis_tab)[1] = c("Variables")
CODis_tab
```

Table 3: Correlation table?
- supplemental table 1: Full diagnostic breakdown of sample 
  + (co-occuring by Disorder)
```{r}
# 
# Vars_dep <- Mothership_lasso |>
#   select( c(
#     Depression_Responder,
#     # Demographics
#     Age_1,Some_College:Married,White, #Discharge,
#     # Treatment info
#     IPT_track_1, Days_complete_1, Days_not_attended_1, #Days_cancel_1,
#     # Disorders
#     Anxiety_D, Mood_D, BPD_P,    Trauma_D, Other,
#     Anxiety_C, Mood_C, BPD_Co_C, Trauma_C, Substance_C, Other_C, No_Co,
#     Current_Dx,
#     # Pre-Post stuff
#     CUDOS_pre,CUXOS_pre, #CUDOS_first,CUXOS_first
#     # RDQ
#     rdqPOST_coping:rdqPOST_wbs  
#     ))
# 
# Vars_anx <- Mothership_lasso |>
#   select( c(
#     Anxiety_Responder,
#     # Demographics
#     Age_1,Some_College:Married,White, #Discharge,
#     # Treatment info
#     IPT_track_1, Days_complete_1, Days_not_attended_1, #Days_cancel_1,
#     # Disorders
#     Anxiety_D, Mood_D, BPD_P,    Trauma_D, Other,
#     Anxiety_C, Mood_C, BPD_Co_C, Trauma_C, Substance_C, Other_C, No_Co,
#     Current_Dx,
#     # Pre-Post stuff
#     CUDOS_pre,CUXOS_pre, #CUDOS_first,CUXOS_first
#     # RDQ
#     rdqPOST_coping:rdqPOST_wbs  
#   ))

#Make a correlation table???

# install.packages("ggcorrplot")
# library(ggcorrplot)
# model.matrix(~0+., data=Mothership_lasso) %>% 
#   cor(use="pairwise.complete.obs") %>% 
#   ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)
# 
# model.matrix(~0+., data=Vars_anx) %>% 
#   cor(use="pairwise.complete.obs") %>% 
#   ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)

```




## Part 3 Logistic lasso

### Lasso Regression
https://glmnet.stanford.edu/articles/glmnet.html
https://www.mygreatlearning.com/blog/understanding-of-lasso-regression/
https://bookdown.org/tpinto_home/Regularisation/lasso-regression.html

https://github.com/sydeaka/Using-Elastic-net-for-model-Selection-with-missing-data/blob/master/model_selection_missing_data-example.R
http://www.sthda.com/english/articles/36-classification-methods-essentials/149-penalized-logistic-regression-essentials-in-r-ridge-lasso-and-elastic-net/

# Depression Lasso 
Preparing data for lasso - depression
```{r}

Vars_dep <- Mothership_lasso_dep |>
  select( c(
    Depression_Responder,
    # Demographics
    Age_1,Some_College:Married,White, 
    # Treatment info
    IPT_track_1, Days_complete_1, Days_not_attended_1, 
    # Disorders
    Anxiety_D, Mood_D, BPD_P,    Trauma_D, #Substance_D, #Psychotic_D,  
    Other,
    Anxiety_C, Mood_C, BPD_Co_C, Trauma_C, Substance_C, Other_C, No_Co,
    Current_Dx,
    # Pre-Post stuff
    CUDOS_pre,CUXOS_pre,
    # RDQ
    rdqPOST_coping:rdqPOST_wbs
  ))

# old model
# Anxiety_D, Mood_D, BPD_P,    Trauma_D,  Other,
#     Anxiety_C, Mood_C, BPD_Co_C, Trauma_C, Substance_C, Other_C, No_Co,
#     Current_Dx,

Vars_dep <- na.omit(Vars_dep)
```

Create test and train data - Depression
```{r}
library(glmnet)
library(caret)
# Create Training and testing data
set.seed(123) 
training.samples <- Vars_dep$Depression_Responder %>% 
  createDataPartition(p = 0.8, list = FALSE)
train.data  <- Vars_dep[training.samples, ]
test.data <- Vars_dep[-training.samples, ]

# Dumy code categorical predictor variables
x.dep <- model.matrix(Depression_Responder~., train.data)[,-1]
# Convert the outcome (class) to a numerical variable
y.dep <- ifelse(train.data$Depression_Responder == "Responder", 1, 0)

#Simplified lasso
lasso1_dep <- glmnet(x.dep, y.dep,family = "binomial", alpha = 1, lambda = NULL,standardize =  TRUE)
plot(lasso1_dep, "lambda", label = TRUE)
```

Find coefficients using cv.lasso- Depression
```{r}
# Find the best lambda using cross-validation
set.seed(123) 
cv.lasso.dep <- cv.glmnet(x.dep, y.dep, alpha = 1, family = "binomial",standardize = TRUE)

#The exact value of lambda can be viewed as follow:
print(paste0("The minimum lambda value is: ", round(cv.lasso.dep$lambda.min,5)))

#This value is called lambda.1se.
print(paste0("The 1 standard error lambda value is: ", round(cv.lasso.dep$lambda.1se,5)))

# Fit the final model on the training data
model.min <- glmnet(x.dep, y.dep, alpha = 1, family = "binomial",
                lambda = cv.lasso.dep$lambda.min,standardize = TRUE)

# Make predictions on the test data
x.test <- model.matrix(Depression_Responder ~., test.data)[,-1]
probabilities <- model.min %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$Depression_Responder
mean(predicted.classes == observed.classes)

#Using lambda.min as the best lambda, gives the following regression coefficients:
coef(cv.lasso.dep, cv.lasso.dep$lambda.min)

#Using lambda.1se as the best lambda, gives the following regression coefficients:
coef(cv.lasso.dep, cv.lasso.dep$lambda.1se)
```

Evaluating if we should use Lasso min or 1SE- Depression
```{r}
####  Using Min
# Final model with lambda.min
lasso.model.min.dep <- glmnet(x.dep, y.dep, alpha = 1, family = "binomial",
                      lambda = cv.lasso.dep$lambda.min, standardized = TRUE)


coef(lasso.model.min.dep)
# Make prediction on test data
x.test <- model.matrix(Depression_Responder ~., test.data)[,-1]
probabilities <- lasso.model.min.dep %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$Depression_Responder
Mean.predict.min.dep <- mean(predicted.classes == observed.classes)

#####  using 1se
# Final model with lambda.1se
lasso.model.1se.dep <- glmnet(x.dep, y.dep, alpha = 1, family = "binomial",
                      lambda = cv.lasso.dep$lambda.1se,standardized = TRUE)
coef(lasso.model.1se.dep)
# Make prediction on test data
x.test <- model.matrix(Depression_Responder ~., test.data)[,-1]
probabilities <- lasso.model.1se.dep %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")

# Model accuracy rate
observed.classes <- test.data$Depression_Responder
Mean.predict.1se.dep <- mean(predicted.classes == observed.classes)

#### full model
# Fit the model
full.model.dep <- glm(Depression_Responder ~ ., data = train.data, family = "binomial")

# Make predictions
probabilities <- full.model.dep %>% predict(test.data, type = "response")
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$Depression_Responder
Mean.predict.full.model.dep <- mean(predicted.classes == observed.classes)

predict.df <- data.frame(
  model = c("Min", "1se", "Full"),
  Mean_Predict = c(Mean.predict.min.dep,Mean.predict.1se.dep,Mean.predict.full.model.dep)
)
predict.df
```

plot the lassos- Depression
If We want to do lasso in ggplot
https://stackoverflow.com/questions/48978179/plotting-lasso-beta-coefficients
```{r}
##plot the lambda
plot(lasso1_dep, "lambda", label = TRUE)
## Fancy plot
library(lars)
lasso_FULL_dep = lars(x.dep, y.dep, type='lasso', 
              trace=TRUE, normalize=FALSE, intercept=TRUE)
plot(lasso_FULL_dep, xvar='norm', breaks = FALSE, 
     plottype = 'coefficients', omit.zeros = TRUE)

#CV k folds cross validation
plot(cv.lasso.dep)
```

### Final relaxed lasso- Depression
Minimum- 
```{r}
## install.packages("fuzzySim")


tmp_coeffs <- coef(lasso.model.min.dep, s = "lambda.min")
Dep_coefs <-tmp_coeffs@Dimnames[[1]][tmp_coeffs@i + 1]
Dep_reg_coefs <- Dep_coefs[2:length(Dep_coefs)]
Dep_reg_coefs
```


```{r}
# min model
glm_min_dep <-
          glm(
    #Outcome varaible
      Depression_Responder ~
    # predictors
      Age_1  + Some_College + Married + IPT_track_1 +
      Days_complete_1 + Days_not_attended_1 + Anxiety_D + Trauma_D +
      Trauma_C + Substance_C +
      rdqPOST_coping + rdqPOST_pmh + rdqPOST_func + rdqPOST_wbs,
    #data
      data = Vars_dep,
    # type of regression : logistic = binary / binomial
      family = "binomial",
    )

# install.packages("rempsyc")
# library(rempsyc)
# nice_table(tidy.summary.min.dep)
  
# Summary of the model
  summary.min.dep      <- summary(glm_min_dep)
  summary.min.dep

  tidy.summary.min.dep <- tidy(glm_min_dep)
  tidy.summary.min.dep
# Coefficients
  coefs.min.dep <- abs(coef(glm_min_dep))

# Odds ratio
  OR.min.dep <- exp(coef(glm_min_dep))
  
# OR 95% CI
  CI.min.dep <- data.frame(exp(confint(glm_min_dep)))
  
  
# P values
  p.values.min.dep <- data.frame(cbind(tidy.summary.min.dep$term,tidy.summary.min.dep$p.value))
  # FDR Adjusted P Values
    adj.p.min.dep <- FDR(pvalues = p.values.min.dep)
    ADJ.p.values.min.dep <- data.frame(rbind(adj.p.min.dep$exclude, adj.p.min.dep$select))
    
# R^2 values  
   R2.min.dep <- performance::r2(glm_min_dep)
  R2.min.dep
# df for Forrest plots
FP.min.dep <- data.frame(cbind(
  Variable = tidy.summary.min.dep$term[2:length(tidy.summary.min.dep$term)],
  OR = OR.min.dep [2:length(OR.min.dep)],
  OR_low  = CI.min.dep [2:length(CI.min.dep$X2.5..),1],
  OR_high = CI.min.dep [2:length(CI.min.dep$X97.5..),2],
  p.values = p.values.min.dep $X2[2:length(p.values.min.dep$X2)]
                    ))

# Left join the FDR adjusted p.value
FP.min.dep <- left_join(FP.min.dep,ADJ.p.values.min.dep, by = join_by(p.values == p.value))
FP.min.dep$OR = round(as.numeric(FP.min.dep$OR),3)
FP.min.dep$OR_low = round(as.numeric(FP.min.dep$OR_low),3)
FP.min.dep$OR_high = round(as.numeric(FP.min.dep$OR_high),3)
FP.min.dep$p.values = round(as.numeric(FP.min.dep$p.values),3)
FP.min.dep$p.adjusted = round(as.numeric(FP.min.dep$p.adjusted),3)
FP.min.dep$type = c("Depression")
FP.min.dep

write_csv(FP.min.dep, "~/Downloads/FP.min.dep")
```
1se -
```{r}
tmp_coeffs <- coef(lasso.model.1se.dep, s = "lambda.1se")
Dep_coefs <-tmp_coeffs@Dimnames[[1]][tmp_coeffs@i + 1]
Dep_reg_coefs <- Dep_coefs[2:length(Dep_coefs)]
Dep_reg_coefs

## 1se model
  glm_1se_dep <-  
      glm(
      #Outcome varaible
        Depression_Responder ~ 
      # predictors
        Days_not_attended_1+ rdqPOST_coping + rdqPOST_pmh + rdqPOST_func + 
        rdqPOST_wbs,
      #data
      data = Vars_dep, 
      # type of regression : logistic = binary / binomial
      family = "binomial")
# Summary of the model
  summary.1se.dep      <- summary(glm_1se_dep)

  tidy.summary.1se.dep <- tidy(glm_1se_dep)
  tidy.summary.1se.dep
# Coefficients
  coefs.1se.dep <- round(abs(coef(glm_1se_dep)),2)

# Odds ratio
  OR.1se.dep <- round(exp(coef(glm_1se_dep)),2)
  
# OR 95% CI
  CI.1se.dep <- round(data.frame(exp(confint(glm_1se_dep))),2)
  
# P values
  p.values.1se.dep <- data.frame(cbind(tidy.summary.1se.dep$term,tidy.summary.1se.dep$p.value))
  # FDR Adjusted P Values
    adj.p.1se.dep <- FDR(pvalues = p.values.1se.dep)
    ADJ.p.values.1se.dep <- data.frame(rbind(adj.p.1se.dep$exclude, adj.p.1se.dep$select))

# R^2 values  
   R2.1se.dep <- performance::r2(glm_1se_dep)

# df for Forrest plots
FP.1se.dep <- data.frame(cbind(
  Variable = tidy.summary.1se.dep$term[2:length(tidy.summary.1se.dep$term)],
  OR = OR.1se.dep [2:length(OR.1se.dep)],
  OR_low  = CI.1se.dep [2:length(CI.1se.dep$X2.5..),1],
  OR_high = CI.1se.dep [2:length(CI.1se.dep$X97.5..),2],
  p.values = p.values.1se.dep$X2[2:length(p.values.1se.dep$X2)]
                    ))

# Left join the FDR adjusted p.value
FP.1se.dep <- left_join(FP.1se.dep,ADJ.p.values.1se.dep, by = join_by(p.values == p.value))
FP.1se.dep$p.adjusted <- round(FP.1se.dep$p.adjusted,2)
FP.1se.dep$type = c("Depression")
FP.1se.dep

write_csv(FP.1se.dep, "~/Downloads/FP.1se.dep")
```




# Anxiety Lasso 
Preparing data for lasso - Anxiety
```{r}

Vars_anx <- Mothership_lasso_anx |>
  select( c(
    Anxiety_Responder,
    # Demographics
    Age_1,Some_College:Married,White, 
    # Treatment info
    IPT_track_1, Days_complete_1, Days_not_attended_1, 
    # Disorders
    Anxiety_D, Mood_D, BPD_P,    Trauma_D, Other,
    Anxiety_C, Mood_C, BPD_Co_C, Trauma_C, Substance_C, Other_C, No_Co,
    Current_Dx,
    # Pre-Post stuff
    CUDOS_pre,CUXOS_pre, #CUDOS_first,CUXOS_first
    # RDQ
    rdqPOST_coping:rdqPOST_wbs
  ))

Vars_anx <- na.omit(Vars_anx)

```

Create test and train data - ANX
```{r}
# Create Training and testing data
set.seed(123) 
training.samples <- Vars_anx$Anxiety_Responder %>% 
  createDataPartition(p = 0.8, list = FALSE)
train.data  <- Vars_anx[training.samples, ]
test.data <- Vars_anx[-training.samples, ]

# Dumy code categorical predictor variables
x <- model.matrix(Anxiety_Responder~., train.data)[,-1]
# Convert the outcome (class) to a numerical variable
y <- ifelse(train.data$Anxiety_Responder == "Responder", 1, 0)

#Simplified lasso
lasso1_anx <- glmnet(x, y,family = "binomial", alpha = 1, lambda = NULL, standardize = TRUE)
plot(lasso1_anx, "lambda", label = TRUE)
```

Find coefficients using cv.lasso- ANX
```{r}
# Find the best lambda using cross-validation
set.seed(123) 
cv.lasso.anx <- cv.glmnet(x, y, alpha = 1, family = "binomial",standardize = TRUE)

#The exact value of lambda can be viewed as follow:
print(paste0("This is the minimum lambda value: ", round(cv.lasso.anx$lambda.min,5)))

#This value is called lambda.1se.
print(paste0("This is the 1 standard error lambda value: ", round(cv.lasso.anx$lambda.1se,5)))

# Fit the final model on the training data
model <- glmnet(x, y, alpha = 1, family = "binomial",
                lambda = cv.lasso.anx$lambda.min, standardized = TRUE)
# Display regression coefficients
# coef(model)
# Make predictions on the test data
x.test <- model.matrix(Anxiety_Responder ~., test.data)[,-1]
probabilities <- model %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$Anxiety_Responder
mean(predicted.classes == observed.classes)

#Using lambda.min as the best lambda, gives the following regression coefficients:
coef(cv.lasso.anx, cv.lasso.anx$lambda.min)

#Using lambda.1se as the best lambda, gives the following regression coefficients:
coef(cv.lasso.anx, cv.lasso.anx$lambda.1se)
```

Evaluating if we should use Lasso min or 1SE- ANX
```{r}
####  Using Min
# Final model with lambda.min
lasso.model.min.anx <- glmnet(x, y, alpha = 1, family = "binomial",
                      lambda = cv.lasso.anx$lambda.min, standardized = TRUE)

coef(lasso.model.min.anx)
# Make prediction on test data
x.test <- model.matrix(Anxiety_Responder ~., test.data)[,-1]
probabilities <- lasso.model.min.anx %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$Anxiety_Responder
Mean.predict.min.anx <- mean(predicted.classes == observed.classes)

#####  using 1se
# Final model with lambda.1se
lasso.model.1se.anx <- glmnet(x, y, alpha = 1, family = "binomial",
                      lambda = cv.lasso.anx$lambda.1se,
                      standardized = TRUE)
coef(lasso.model.1se.anx)
# Make prediction on test data
x.test <- model.matrix(Anxiety_Responder ~., test.data)[,-1]
probabilities <- lasso.model.1se.anx %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")

# Model accuracy rate
observed.classes <- test.data$Anxiety_Responder
Mean.predict.1se.anx <- mean(predicted.classes == observed.classes)

#### full model
# Fit the model
full.model.anx <- glm(Anxiety_Responder ~ ., data = train.data, family = "binomial")

# Make predictions
probabilities <- full.model.anx %>% predict(test.data, type = "response")
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$Anxiety_Responder
Mean.predict.full.model.anx <- mean(predicted.classes == observed.classes)

predict.df <- data.frame(
  model = c("Min", "1se", "Full"),
  values = c(Mean.predict.min.anx,Mean.predict.1se.anx,Mean.predict.full.model.anx)
)
predict.df
```

plot the lassos- Anx
If We want to do lasso in ggplot
https://stackoverflow.com/questions/48978179/plotting-lasso-beta-coefficients
```{r}
##plot the lambda
plot(lasso1_anx, "lambda", label = TRUE)
## Fancy plot
library(lars)
lasso_FULL_anx = lars(x, y, type='lasso', 
              trace=TRUE, normalize=FALSE, intercept=TRUE)
plot(lasso_FULL_anx, xvar='norm', breaks = FALSE, 
     plottype = 'coefficients', omit.zeros = TRUE)

#CV k folds cross validation
plot(cv.lasso.anx)
```

### Final relaxed lasso- anx
Minimum- 
```{r}
## install.packages("fuzzySim")
library(fuzzySim) ## For FDR adjusted p values
library(broom) # for tidy regression output

tmp_coeffs <- coef(lasso.model.min.anx, s = "lambda.min")
Anx_coefs <-tmp_coeffs@Dimnames[[1]][tmp_coeffs@i + 1]
Anx_reg_coefs <- Anx_coefs[2:length(Anx_coefs)]
Anx_reg_coefs

## min model
  glm_min_anx <-  
      glm(
      #Outcome varaible
        Anxiety_Responder ~ 
      # predictors
        Age_1 + Married + Days_complete_1 + 
        Days_not_attended_1 + Anxiety_D + Trauma_D +
        Other + Mood_C + BPD_Co_C + 
        Substance_C + CUXOS_pre +  rdqPOST_coping + 
        rdqPOST_pmh + rdqPOST_func + rdqPOST_wbs,
      #data
      data = Vars_anx, 
      # type of regression : logistic = binary / binomial
      family = "binomial")
  
# Summary of the model
  summary.min.anx      <- summary(glm_min_anx)

  tidy.summary.min.anx <- tidy(glm_min_anx)
  tidy.summary.min.anx
# Coefficients
  coefs.min.anx <- round(abs(coef(glm_min_anx)),3)

# Odds ratio
  OR.min.anx <- round(exp(coef(glm_min_anx)),3)
# OR 95% CI
  CI.min.anx <- data.frame(exp(confint(glm_min_anx)))
  CI.min.anx[,1] = round(CI.min.anx[,1],3)
  CI.min.anx[,2] = round(CI.min.anx[,2],3)
# P values
  p.values.min.anx <- data.frame(cbind(tidy.summary.min.anx$term,tidy.summary.min.anx$p.value))
  # FDR Adjusted P Values
    adj.p.min.anx <- FDR(pvalues = p.values.min.anx)
    ADJ.p.values.min.anx <- data.frame(rbind(adj.p.min.anx$exclude, adj.p.min.anx$select))
    ADJ.p.values.min.anx
# R^2 values  
   R2.min.anx <- performance::r2(glm_min_anx)
   R2.min.anx

#wald
   library(aod)
   wald.test(b = coef(glm_min_anx),Sigma = vcov(glm_min_anx),Terms= 2:15)
   
# df for Forrest plots
FP.min.anx <- data.frame(cbind(
  Variable = tidy.summary.min.anx$term[2:length(tidy.summary.min.anx$term)],
  OR = OR.min.anx [2:length(OR.min.anx)],
  OR_low  = CI.min.anx [2:length(CI.min.anx$X2.5..),1],
  OR_high = CI.min.anx [2:length(CI.min.anx$X97.5..),2],
  p.values = p.values.min.anx$X2[2:length(p.values.min.anx$X2)]
                    ))


# Left join the FDR adjusted p.value and round
FP.min.anx <- left_join(FP.min.anx,ADJ.p.values.min.anx, by = join_by(p.values == p.value))
FP.min.anx$p.values = round(as.numeric(FP.min.anx$p.values),3)
FP.min.anx$p.adjusted = round(as.numeric(FP.min.anx$p.adjusted),3)
FP.min.anx$type = c("Anxiety")
FP.min.anx

write_csv(FP.min.anx, "~/Downloads/FP.min.anx")
```
1se -
```{r}
tmp_coeffs <- coef(lasso.model.1se.anx, s = "lambda.1se")
Anx_coefs2 <-tmp_coeffs@Dimnames[[1]][tmp_coeffs@i + 1]
Anx_reg_coefs2 <- Anx_coefs[2:length(Anx_coefs)]
Anx_reg_coefs2

## 1se model
  glm_1se_anx <-  
      glm(
      #Outcome varaible
        Anxiety_Responder ~ 
      # predictors
         Days_not_attended_1 + rdqPOST_coping + rdqPOST_pmh + rdqPOST_func + rdqPOST_wbs,
      #data
      data = Vars_anx, 
      # type of regression : logistic = binary / binomial
      family = "binomial")
# Summary of the model

  summary.1se.anx      <- summary(glm_1se_anx)

  tidy.summary.1se.anx <- tidy(glm_1se_anx)
  tidy.summary.1se.anx
# Coefficients
  coefs.1se.anx <- round(abs(coef(glm_1se_anx)),3)

# Odds ratio
  OR.1se.anx <- round(exp(coef(glm_1se_anx)),3)
  
# OR 95% CI
  CI.1se.anx <- data.frame(exp(confint(glm_1se_anx)))
  CI.1se.anx[,1] = round(CI.1se.anx[,1],3)
  CI.1se.anx[,2] = round(CI.1se.anx[,2],3)
  
# P values
  p.values.1se.anx <- data.frame(cbind(tidy.summary.1se.anx$term,tidy.summary.1se.anx$p.value))
  # FDR Adjusted P Values
    adj.p.1se.anx <- FDR(pvalues = p.values.1se.anx)
    ADJ.p.values.1se.anx <- data.frame(rbind(adj.p.1se.anx$exclude, adj.p.1se.anx$select))

# R^2 values  
   R2.1se.anx <- performance::r2(glm_1se_anx)

# df for Forrest plots
FP.1se.anx <- data.frame(cbind(
  Variable = tidy.summary.1se.anx$term[2:length(tidy.summary.1se.anx$term)],
  OR = OR.1se.anx [2:length(OR.1se.anx)],
  OR_low  = CI.1se.anx [2:length(CI.1se.anx$X2.5..),1],
  OR_high = CI.1se.anx [2:length(CI.1se.anx$X97.5..),2],
  p.values = p.values.1se.anx$X2[2:length(p.values.1se.anx$X2)]
                    ))

# Left join the FDR adjusted p.value
FP.1se.anx <- left_join(FP.1se.anx,ADJ.p.values.1se.anx, by = join_by(p.values == p.value))
FP.1se.anx$p.values = round(as.numeric(FP.1se.anx$p.values),3)
FP.1se.anx$p.adjusted = round(as.numeric(FP.1se.anx$p.adjusted),3)
FP.1se.anx$type = c("Anxiety")
FP.1se.anx

write_csv(FP.1se.anx, "~/Downloads/FP.1se.anx")
```


# Forrest Plot 

Anxiety Plot
```{r}
#Create order varaible in dataset to keep it the same as the regression

FP_anx <- read_csv("~/Downloads/FP.min.anx")
# FP_anx <- read_csv("~/Downloads/FP.1se.anx")

#Change the names of variables
FP_anx$Variable = c("Age", "Unmarried", "Days Completed", 
                    "Days Not Attended", "Anixety Disorder","Trauma Disorder", 
                    "Other Disorder", "Co-Mood Disorder",  "Co-BPD", 
                    "Co-SUD", "CUXOS Pre", "Post Coping", 
                    "Post PMH", "Post Functioning", "Post Wellbeing")

FP_anx$order = c(seq(from=2, to=length(FP_anx$Variable) + 1,1))

FP_anx <- FP_anx |>
  mutate(
    sig = ifelse(p.adjusted <= 0.05, 16,1)
  )

FP_anx_m <- FP_anx |>
  ggplot(aes(y = reorder(Variable, -order), color = as.factor(sig))) +
  #take away background
  theme_classic() +
  #make the forrest plot
  geom_point(aes(x=OR), shape= FP_anx$sig,
               # ifelse(FP_anx$p.adjusted <= 0.05, 
               #                        16, # colored ones for significant varaibles
               #                        1), # uncolored ones for insignificant varaibles
             size=3.5,show.legend = FALSE) +
  geom_linerange(aes(xmin=OR_low, xmax=OR_high),size = .4, show.legend = FALSE) +
  geom_errorbar(aes(xmin=OR_low, xmax=OR_high),width =.5, show.legend = FALSE)+
  scale_color_manual(values = c("darkgrey","red"))+
  #change x axis name
  labs(
    x="Odds Ratio") +
    # title = "Odds of Anxiety Treatment Non-Response",
    # subtitle = "Based on Pre/Post CUXOS Scores in PHP program") +
  #adjust the dimentions. 
  coord_cartesian(ylim = c(1,length(FP_anx$Variable) + 1),
                  xlim = c(.25,2.0)) +
  #add a line at 1 for reference 
   geom_vline(xintercept = 1, linetype="dashed", alpha = .5) +
  #add anotations to help suggests what each side means.
  annotate("text", x = .6, y = length(FP_anx$Variable) + 1, label = "Less Likely", size= 3) +
  annotate("text", x = 1.5, y = length(FP_anx$Variable) + 1, label = "More Likely",size= 3) +
  #Git rid of the Y - Axis
    theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())

FP_anx_m

FP_anx <- FP_anx |>
  # round estimates and 95% CIs to 2 decimal places for journal specifications
  mutate(across(
    c(OR, OR_low, OR_high),
    ~ str_pad(
      round(.x, 2),
      width = 4,
      pad = "0",
      side = "right"
    )
  ),
  # add an "-" between HR estimate confidence intervals
  estimate_lab = paste0(OR, " (", OR_low, "-", OR_high, ")")) |>
  # round p-values to two decimal places, except in cases where p < .001
  mutate(p.adjusted_fig = case_when(
    p.adjusted < .001 ~ "<0.001",
    round(p.adjusted, 2) == .05 ~ as.character(round(p.adjusted,3)),
    p.adjusted < .01 ~ str_pad( # if less than .01, go one more decimal place
      as.character(round(p.adjusted, 3)),
      width = 4,
      pad = "0",
      side = "right"
    ),
    TRUE ~ str_pad( # otherwise just round to 2 decimal places and pad string so that .2 reads as 0.20
      as.character(round(p.adjusted, 2)),
      width = 4,
      pad = "0",
      side = "right"
    )
  )) |>
  # add a row of data that are actually column names which will be shown on the plot in the next step
  bind_rows(
    data.frame(
      Variable = "Variable",
      estimate_lab = "Odds Ratio (95% CI)",
      OR_low = "",
      OR_high = "",
      p.adjusted_fig = "p value"
    )
  ) 

FP_anx[length(FP_anx$Variable),8] = 1
FP_anx

#arange the labels on top
      FP_anx<-mutate(FP_anx, top_row = 0)
      FP_anx[length(FP_anx$Variable),12] = 1
      FP_anx <- arrange(FP_anx,order)
FP_anx
    # plot the left side of the plot 
      FP_anx_L <- FP_anx %>% 
        ggplot(aes(y = reorder(Variable, -order))) +
        geom_text(aes(x = 0, label = Variable), hjust = 0, fontface = "bold")+
        geom_text(aes(x = 1, label = estimate_lab),
        hjust = 0,
        fontface = ifelse(FP_anx$estimate_lab == "Odds Ratio (95% CI)", "bold","plain")) +
        theme_void() +
        coord_cartesian(ylim = c(1,length(FP_anx$Variable)), xlim = c(0, 4))

FP_anx_L

FP_anx_R <-  
      FP_anx |>
      ggplot() +
        geom_text(aes(x = 0, y = reorder(Variable, -order), label = p.adjusted_fig), hjust = 0,
        fontface = ifelse(FP_anx$p.adjusted_fig == "p value", "bold", "plain")) +
        theme_void() +
        coord_cartesian(ylim = c(1,length(FP_anx$Variable)))
        
FP_anx

library("patchwork")

layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 30),
  patchwork::area(t = 0, l = 16, b = 30, r = 25),
  patchwork::area(t = 0, l = 22, b = 30, r = 30) 
  )

FP_anx_L + FP_anx_m + FP_anx_R + plot_layout(design = layout)

```
## Depression Plot
```{r}
#Create order varaible in dataset to keep it the same as the regression



FP_dep <- read_csv("~/Downloads/FP.1se.dep")

#rename the variables for the figure

FP_dep$Variable = c(
                     "Days Not Attended",
                    "Post Coping", 
                    "Post PMH", "Post Functioning", "Post Wellbeing")


FP_dep$order = c(seq(from=2, to=length(FP_dep$Variable) + 1,1))

FP_dep <- FP_dep |>
  mutate(
    sig = ifelse(p.adjusted <= 0.05, 16,1)
  )

FP_dep_m <- FP_dep |>
  ggplot(aes(y = reorder(Variable, -order), color = as.factor(sig))) +
  #take away background
  theme_classic() +
  #make the forrest plot
  geom_point(aes(x=OR), shape= FP_dep$sig,
               # ifelse(FP_dep$p.adjusted <= 0.05, 
               #                        16, # colored ones for significant varaibles
               #                        1), # uncolored ones for insignificant varaibles
             size=4,show.legend = FALSE) +
  geom_linerange(aes(xmin=OR_low, xmax=OR_high),size = .4, show.legend = FALSE) +
  geom_errorbar(aes(xmin=OR_low, xmax=OR_high),width =.35, show.legend = FALSE)+
  scale_color_manual(values = c("darkgrey","blue"))+
  #change x axis name
  labs(
    x="Odds Ratio") +
    # title = "Odds of Anxiety Treatment Non-Response",
    # subtitle = "Based on Pre/Post CUXOS Scores in PHP program") +
  #adjust the dimentions. 
  coord_cartesian(ylim = c(1,length(FP_dep$Variable) + 1),
                  xlim = c(.5,1.5)) +
  #add a line at 1 for reference 
   geom_vline(xintercept = 1, linetype="dashed", alpha = .5) +
  #add anotations to help suggests what each side means.
  annotate("text", x = .75, y = length(FP_dep$Variable) + 1, label = "Less Likely", size= 4) +
  annotate("text", x = 1.25, y = length(FP_dep$Variable) + 1, label = "More Likely",size= 4) +
  #Git rid of the Y - Axis
    theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())

FP_dep_m

FP_dep <- FP_dep |>
  # round estimates and 95% CIs to 2 decimal places for journal specifications
  mutate(across(
    c(OR, OR_low, OR_high),
    ~ str_pad(
      round(.x, 2),
      width = 4,
      pad = "0",
      side = "right"
    )
  ),
  # add an "-" between HR estimate confidence intervals
  estimate_lab = paste0(OR, " (", OR_low, "-", OR_high, ")")) |>
  # round p-values to two decimal places, except in cases where p < .001
  mutate(p.adjusted_fig = case_when(
    p.adjusted < .001 ~ "<0.001",
    round(p.adjusted, 2) == .05 ~ as.character(round(p.adjusted,3)),
    p.adjusted < .01 ~ str_pad( # if less than .01, go one more decimal place
      as.character(round(p.adjusted, 3)),
      width = 4,
      pad = "0",
      side = "right"
    ),
    TRUE ~ str_pad( # otherwise just round to 2 decimal places and pad string so that .2 reads as 0.20
      as.character(round(p.adjusted, 2)),
      width = 4,
      pad = "0",
      side = "right"
    )
  )) |>
  # add a row of data that are actually column names which will be shown on the plot in the next step
  bind_rows(
    data.frame(
      Variable = "Variable",
      estimate_lab = "Odds Ratio (95% CI)",
      OR_low = "",
      OR_high = "",
      p.adjusted_fig = "p value"
    )
  ) 

FP_dep[length(FP_dep$Variable),8] = 1
FP_dep

#arange the labels on top
      FP_dep<-mutate(FP_dep, top_row = 0)
      FP_dep[length(FP_dep$Variable),12] = 1
      FP_dep <- arrange(FP_dep,order)
FP_dep
    # plot the left side of the plot 
      FP_dep_L <- FP_dep %>% 
        ggplot(aes(y = reorder(Variable, -order))) +
        geom_text(aes(x = 0, label = Variable), hjust = 0, fontface = "bold")+
        geom_text(aes(x = 1, label = estimate_lab),
        hjust = 0,
        fontface = ifelse(FP_dep$estimate_lab == "Odds Ratio (95% CI)", "bold","plain")) +
        theme_void() +
        coord_cartesian(ylim = c(1,length(FP_dep$Variable)), xlim = c(0, 4))

FP_dep_L

FP_dep_R <-  
      FP_dep |>
      ggplot() +
        geom_text(aes(x = 0, y = reorder(Variable, -order), label = p.adjusted_fig), hjust = 0,
        fontface = ifelse(FP_dep$p.adjusted_fig == "p value", "bold", "plain")) +
        theme_void() +
        coord_cartesian(ylim = c(1,length(FP_dep$Variable)))
        
FP_dep

library("patchwork")

layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 30),
  patchwork::area(t = 0, l = 15, b = 30, r = 25),
  patchwork::area(t = 0, l = 22, b = 30, r = 30) 
  )

FP_dep_L + FP_dep_m + FP_dep_R + plot_layout(design = layout)
```











