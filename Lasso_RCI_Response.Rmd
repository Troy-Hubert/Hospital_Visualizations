---
title: "Lasso_RCI_Response"
author: Troy Hubert
output: html_document
date: "2024-01-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Libraries
library(tidyverse)
library(dplyr)
library(haven)
library(ggplot2)
library(tidyr)
```

# Prep data for analysis 

## Read in the dataset. 
```{r}
Mothership <- read_sav("~/Desktop/Coding/data/PHPoutcome_clean.sav")
#DF_1<- read_sav("~/Desktop/Coding/data/PHPoutcome_clean.sav")

```


## Clean, update, and wrangle data

The code below reads in the data frame, and prepares df for analysis.

this includes:
  1 Re-coding / Renaming variables
  2 Creating new Diagnostic variables 
  3 Functions to create Pre - post scores 
  4 RCI Analysis categorization
  5 Pre - Post long data sets

```{r}
# 1. Re-coding / Renaming variables ------------------------------------------
# We can change the current variables to make them easier to interpret.

#recode varaibles
Mothership <- mutate(Mothership, 
                     Education_1 = as.factor(Education_1),
                     Education_1 = recode(Education_1,
                                          "0"="<Grade 12",
                                          "1"="<Grade 12",
                                          "2"="HS Diploma or GED",
                                          "3"="HS Diploma or GED",
                                          "4"="Some College/Associates Degree",
                                          "5"="Some College/Associates Degree",
                                          "6"="Bachelors Degree",
                                          "7"="Bachelors Degree",
                                          "8"="Grad Degree"),
                     Some_College = Education_1,
                     Some_College = recode(Education_1,
                                          "<Grade 12" = "0",
                                          "<Grade 12" = "0",
                                          "HS Diploma or GED" = "0",
                                          "HS Diploma or GED" = "0",
                                          "Some College/Associates Degree" = "1",
                                          "Some College/Associates Degree" = "1",
                                          "Bachelors Degree" = "1",
                                          "Bachelors Degree" = "1",
                                          "Grad Degree" ="1"),
                     Gender_1 = as.factor(Gender_1),
                     Gender_1 = recode(Gender_1,
                                       "0"="Female",
                                       "1"="Male",
                                       "2"="Non-Binary",
                                       "3"="Other",
                                       "4"="Other"),
                     Female = Gender_1,
                     Female= recode(Gender_1,
                                       "Female" = "1",
                                       "Male" = "0",
                                       "Non-Binary" = "0",
                                       "Other" = "0",
                                       "Other" = "0"),
                      Relationship_1 = ifelse(Relationship_1 == 8, NA, Relationship_1),
                     Relationship_1 = as.factor(Relationship_1),
                     Relationship_1 = recode(Relationship_1,
                                             "0"="Married or Cohabitating",
                                             "1"="Married or Cohabitating",
                                             "2"="Widowed or Separated",
                                             "3"="Widowed or Separated",
                                             "4"="Divorced",
                                             "5"="Single or Never Married"),
                     Married = recode(Relationship_1,
                                             "Married or Cohabitating" = "1",
                                             "Widowed or Separated" = "0",
                                             "Divorced" = "0",
                                             "Single or Never Married" = "0"),
                     Sexuality_1 = as.factor(Sexuality_1),
                     Sexuality_1 = recode(Sexuality_1,
                                          "1"="Straight",
                                          "2"="Gay",
                                          "3"="Bisexual",
                                          "4"="Other"),
                     Straight = recode(Sexuality_1,
                                         "Straight" = "1",
                                          "Gay" = "0",
                                          "Bisexual" = "0",
                                          "Other" = "0"),
                     IPT_track_1 = as.factor(IPT_track_1),
                     IPT_track_1 = recode(IPT_track_1,
                                          "0"="General",
                                          "1"="Trauma",
                                          "2"="Young Adult",
                                          "3"="BPD"),
                     Race_1 = ifelse(Race_1 == 6, NA, Race_1),
                     Race_1 = as.factor(Race_1),
                     Race_1 = recode(Race_1,
                                     "0"="White",
                                     "1"="Black",
                                     "2"="Hispanic",
                                     "3"="Asian",
                                     "4"="Portugese",
                                     "5"="Other"),
                     White = recode(Race_1,
                                     "White" = "1",
                                     "Black" = "0",
                                     "Hispanic"="0",
                                     "Asian"="0",
                                     "Portugese"="0",
                                     "Other"="0"),
                     DC_status_1 = as.factor(DC_status_1),
                     DC_status_1 = recode(DC_status_1,
                                          "1" ="Treatment Complete",
                                          "2" ="Treatment nearly complete",
                                          "3" ="Insurance no longer covering",
                                          "4" ="Nonattendance",
                                          "5" ="Inappropriate (language)/Referred to another tx setting",
                                          "6" ="Transferred to inpatient",
                                          "7" ="Withdrew due to external limitations",
                                          "8"= "Withdrew AMA",
                                          "9"= "Other",
                                          "10"="Other",
                                          "0" ="Other"),
                     Discharge = recode(DC_status_1,
                                          "Treatment Complete" = "1",
                                          "Treatment nearly complete" = "1",
                                          "Insurance no longer covering" = "0",
                                          "Nonattendance" = "0",
                                          "Inappropriate (language)/Referred to another tx setting" ="0",
                                          "Transferred to inpatient"="0",
                                          "Withdrew due to external limitations"="0",
                                          "Withdrew AMA"="0",
                                          "Other"="0",
                                          "Other"="0",
                                          "Other"="0"),
#Lets make some new variables 
                     #Duration of treatment
                     Duration = as.factor(
                       ifelse(Days_complete_1>0 & Days_complete_1 <=5, "1",
                              ifelse(Days_complete_1>5 & Days_complete_1 <=10, "2",
                                     ifelse(Days_complete_1>10 & Days_complete_1 <=15, "3",
                                            ifelse(is.na(Days_complete_1), NA, "4"
                                            ))))),
                     Duration_lab = as.factor(recode(Duration,
                                                     "1"="1-5",
                                                     "2"="6-10",
                                                     "3"="11-15",
                                                     "4"="16+")),
                     Duration_10 = as.factor(
                       ifelse(Duration == 1 | Duration == 2, "1",
                              ifelse(Duration == 3 | Duration == 4, "2", NA)
                       )))

#Extract Year From Intake Date
#Convert to Date
library("lubridate")
Mothership$Intake_1<-ymd(Mothership$Intake_1)
Mothership$TxYear<-as.numeric(format(Mothership$Intake_1,"%Y"))
Mothership<-mutate(Mothership,
                   TxYear = as.factor(TxYear),
                   TxYear = recode(TxYear,
                                   "1582"="2014"))

####  Export as CSV
write.csv(Mothership,"~/Desktop/Coding/data/Mothership_paper")

# 2. Creating new diagnostic variables  -----------------------------------

Mothership<-Mothership %>%
  mutate(
    # Mood Disorders
    Mood_D = as.factor(
      ifelse(
        MDD_P ==1 | Bipolar1_P == 1 | Bipolar2_P == 1 | Dysthymia_P == 1, 1, 0)),
    # Anxiety Disorders
    Anxiety_D = as.factor(
      ifelse(
        GAD_P ==1 | Panic_P == 1 | PanicAgor_P == 1 | Agoraphobia_P == 1 |
          Social_P == 1 | Specific_P == 1 | OCD_P == 1, 1, 0)),
    # Obsessive Compusive Disorders
    #OCD_P is for current OCD
        #OCD_P = as.factor(OCD_P),
    # Personality Disorders
    #BPD_P is for current BPD
    BPD_P = as.factor(BPD_P),
    # Substance Use Disorders
    Substance_D = as.factor(
      ifelse(
        Alcohol_P == 1 | Drug_P ==1, 1, 0)),
    # Trauma or stresor related disorders
    Trauma_D = as.factor(
      ifelse(PTSD_P == 1 | Adjustment_P ==1, 1,0)),
    # Psychotic Disorders
    Psychotic_D = as.factor(
      ifelse(
        Schiz_P == 1 | Schizaff_P == 1,1,0)),
    # Eating Disorders
    Eating_D = as.factor(
      ifelse(
        Anorex_P == 1 | Bulim_P == 1 | Binge_P == 1, 1,0)),
    # Somatic Disroders
    Somatic_D = as.factor(
      ifelse(
        Somat_P == 1 | UndiffSoma_P == 1| Hypochondriasis_P ==1,
        1,0)),
    Other = as.factor(
      ifelse(
        Somat_P == 1 | UndiffSoma_P == 1| Hypochondriasis_P ==1 |
          Anorex_P == 1 | Bulim_P == 1 | Binge_P == 1 | 
          Schiz_P == 1 |  Schizaff_P == 1,  
        1,0)),
    Disorder_Type = as.factor(
      ifelse(Anxiety_D == 1, "Anxiety",
                    ifelse(BPD_P == 1, "BPD",
                           ifelse(Substance_D == 1, "Substance Use",
                                  ifelse(Trauma_D == 1, "Trauma",
                                         ifelse(Mood_D == 1, "Mood",
                                                ifelse(Psychotic_D == 1, "Psychotic", 
                                                       ifelse(Eating_D == 1, "Eating", 
                                                              ifelse(Somatic_D == 1, "Somatic", NA
                                                              ))))))))),
    Disorder_treat = as.factor(
      ifelse(Anxiety_D == 1, "Anxiety",
             ifelse(BPD_P == 1, "BPD",
                    ifelse(Trauma_D == 1, "Trauma",
                           ifelse(Mood_D == 1, "Mood",
                                  #ifelse(OCD_P == 1, "Anxiety",
                                     #felse(OCD_P == 1, "Other",
                                         ifelse(Substance_D == 1, "Other",
                                                ifelse(Psychotic_D == 1, "Other", 
                                                       ifelse(Eating_D == 1, "Other",
                                                          ifelse(Somatic_D == 1, "Other",NA
                                                       ))))))))),
    Anxiety_C =  as.factor(
      ifelse( GAD_P !=1 & GAD_C ==1 | 
                Panic_P != 1 & Panic_C == 1 | 
                PanicAgor_P != 1 & PanicAgor_C == 1 | 
                Agoraphobia_P != 1 & Agoraphobia_C == 1 |
                Social_P != 1 & Social_C == 1 | 
                #OCD_P != 1 & OCD_C == 1 |
                Specific_P != 1 & Specific_C == 1, 1, 0)),
    Mood_C =  as.factor(
      ifelse( MDD_P != 1 & MDD_C == 1 |
                Bipolar1_P != 1 & Bipolar1_C == 1 | 
                Bipolar2_P != 1 &  Bipolar2_C == 1 | 
                Dysthymia_P != 1 & Dysthymia_C == 1 , 1, 0)),
    Substance_C = as.factor(
      ifelse(Alcohol_P != 1 & Alcohol_C == 1 | 
               Drug_P != 1 & Drug_C ==1, 1, 0)),
    Trauma_C = as.factor(
      ifelse(PTSD_P != 1 & PTSD_C == 1 | 
               Adjustment_P != 1 & Adjustment_C ==1, 1,0)),
    Psychotic_C = as.factor(
      ifelse(Schiz_P != 1 & Schiz_C == 1 | 
               Schizaff_P != 1 & Schizaff_C == 1,1,0)),
    Eating_C = as.factor(
      ifelse(Anorex_P != 1 & Anorex_C == 1 | 
               Bulim_P != 1 & Bulim_C == 1 | 
                  Binge_P != 1 & Binge_C == 1, 1,0)),
    Somatic_C = as.factor(
      ifelse(Somat_P != 1 & Somat_C == 1 | 
               UndiffSoma_P != 1 & UndiffSoma_C == 1 | 
               Hypochondriasis_P != 1 &  Hypochondriasis_C == 1, 1,0)),
    Other_C = as.factor(
      ifelse(
        Somatic_C == 1 | Eating_C == 1 | Psychotic_C == 1, 1, 0)),

    #OCD_Co_C = as.factor(
     # ifelse(OCD_P != 1 & OCD_C == 1,1,0)),
    BPD_Co_C = as.factor(
      ifelse(BPD_P != 1 & BPD_C ==1,1,0)),
    No_Co = as.factor(
      ifelse(BPD_Co_C == 0 &
               Somatic_C == 0 & 
               Eating_C == 0 &
               Psychotic_C == 0 &
               Trauma_C == 0 & 
               Substance_C == 0 &
               Mood_C == 0 &
               Anxiety_C == 0, 1,0)),
    Other_Co = as.factor(
      ifelse(  Somatic_C == 1 & 
               Eating_C == 1 &
               Psychotic_C == 1,1,0)),
    
    #emotional disorders
    Emotional_dis = as.factor(
      ifelse(Anxiety_D == 1 | OCD_P == 1 | Trauma_D == 1 |
               Mood_D == 1, "Emotional Disorder", "Other Disorder")),
    
    # co occuring disorders
    Co_Anx = as.factor(
      ifelse(Anxiety_C == 1 & Mood_D == 1 |
               Anxiety_C == 1 & BPD_P == 1 |
               Anxiety_C == 1 & Substance_D == 1 |
               Anxiety_C == 1 & Trauma_D == 1 |
               Anxiety_C == 1 & Eating_D ==1 |
               Anxiety_C == 1 & Psychotic_D ==1 |
               Anxiety_C == 1 & Somatic_D ==1, 1, 0)),
    Co_Mood = as.factor(
      ifelse(Mood_C == 1 & Anxiety_D == 1 |
               Mood_C == 1 & BPD_P == 1 |
               Mood_C == 1 & Substance_D == 1 |
               Mood_C == 1 & Trauma_D == 1 |
               Mood_C == 1 & Eating_D ==1 |
               Mood_C == 1 & Psychotic_D ==1 |
               Mood_C == 1 & Somatic_D==1 , 1, 0)),
    Co_BPD = as.factor(
      ifelse(BPD_Co_C == 1 & Anxiety_D == 1 |
               BPD_Co_C == 1 & Mood_D == 1 |
               BPD_Co_C == 1 & Substance_D == 1 |
               BPD_Co_C == 1 & Trauma_D == 1 |
               BPD_Co_C == 1 & Eating_D ==1 |
               BPD_Co_C == 1 & Psychotic_D ==1 |
               BPD_Co_C == 1 & !BPD_P == 
               BPD_Co_C == 1 & Somatic_D ==1 , 1, 0)),
    Co_Psychotic = as.factor(
      ifelse(Psychotic_C == 1 & Mood_D == 1 |
               Psychotic_C == 1 & BPD_P == 1 |
               Psychotic_C == 1 & Substance_D == 1 |
               Psychotic_C == 1 & Trauma_D == 1 |
               Psychotic_C == 1 & Eating_D ==1 |
               Psychotic_C == 1 & Anxiety_D ==1 |
               Psychotic_C == 1 & Somatic_D ==1, 1, 0)),
    Co_Eating = as.factor(
      ifelse(Eating_C == 1 & Mood_D == 1 |
               Eating_C == 1 & BPD_P == 1 |
               Eating_C == 1 & Substance_D == 1 |
               Eating_C == 1 & Trauma_D == 1 |
               Eating_C == 1 & Psychotic_D ==1 |
               Eating_C == 1 & Anxiety_D ==1 |
               Eating_C == 1 & Somatic_D ==1, 1, 0)),
    Co_Somatic =  as.factor(
      ifelse(Somatic_C == 1 & Mood_D == 1 |
               Somatic_C == 1 & BPD_P == 1 |
               Somatic_C == 1 & Substance_D == 1 |
               Somatic_C == 1 & Trauma_D == 1 |
               Somatic_C == 1 & Eating_D ==1 |
               Somatic_C == 1 & Anxiety_D ==1 |
               Somatic_C == 1 & Substance_D ==1 |
               Somatic_C == 1 & Psychotic_D ==1, 1, 0)),
    Co_Substance = as.factor(
      ifelse(Substance_C == 1 & Mood_D == 1 |
               Substance_C == 1 & BPD_P == 1 |
               Substance_C == 1 & Substance_D == 1 |
               Substance_C == 1 & Trauma_D == 1 |
               Substance_C == 1 & Eating_D ==1 |
               Substance_C == 1 & Anxiety_D ==1 |
               Substance_C == 1 & Somatic_D ==1 |
               Substance_C == 1 & Psychotic_D ==1, 1, 0)),
    Co_Trauma = as.factor(
      ifelse(Trauma_C == 1 & Mood_D == 1 |
               Trauma_C == 1 & BPD_P == 1 |
               Trauma_C == 1 & Substance_D == 1 |
               Trauma_C == 1 & Eating_D ==1 |
               Trauma_C == 1 & Anxiety_D ==1 |
               Trauma_C == 1 & Somatic_D ==1 |
               Trauma_C == 1 & Psychotic_D ==1, 1, 0)),
    Co_Other = as.factor(
      ifelse(
        Co_Substance == 1 |
        Co_Somatic == 1 |
        Co_Eating == 1 |
        Co_Psychotic == 1, 1, 0))
      )

summary(Mothership$Co_Anx)
table(Mothership$Anxiety_D, Mothership$Co_Anx)
##### df for plots 

# only include people that attend treatment & its thier first time attending
Mothership <- Mothership |>
  filter(
    is.na(Prev_AdmitID_1),
    C_Admit_1 == 1
  ) |>
  mutate(
    dummy = -99
  ) |>
  filter(!is.na(Disorder_treat),
         !is.na(TxYear),
         !is.na(Duration))

# df without NAs in date and disorder type

Mothership_Diag_treat <- Mothership |>
  filter(!is.na(Disorder_treat),
         !is.na(TxYear),
         !is.na(Duration))

### Export as CSV
write.csv(Mothership,"~/Desktop/Coding/data/Mothership_Diag_treat.csv")

# 3. Functions to create Pre - post scores -----------------------------------

#1. load DF
  Mothership_post <- Mothership

  # Depression
    CUDOS_Score_post <-  select(Mothership_post, dummy,Day1_CUDOS:Day40_CUDOS)
  # Anxiety
    CUXOS_Score_post <- select(Mothership_post, dummy,Day1_CUXOS:Day40_CUXOS)

#2. Getting post scores for people who have NA for post

  # Depression
    Post_DEP <- NA
    PD_df <- NA
    for(i in 1:nrow(CUDOS_Score_post)){
      PD_df <- unname(unlist(CUDOS_Score_post[i,]))
      PD_df <- PD_df[!is.na(PD_df)]
      PD_df <- tail(PD_df, n=1)
      Post_DEP <- rbind(Post_DEP,PD_df)
    }
    Post_Dep <- Post_DEP[-1]

  # Anxiety
    Post_ANX <- NA
    PA_df <- NA
    for(i in 1:nrow(CUXOS_Score_post)){
      PA_df <- unname(unlist(CUXOS_Score_post[i,]))
      PA_df <- PA_df[!is.na(PA_df)]
      PA_df <- tail(PA_df, n=1)
      Post_ANX <- rbind(Post_ANX,PA_df)
    }
    Post_anx <- Post_ANX[-1]

# 3. Getting BL scores for people who have NA at Baseline 

  # Depression / Anxiety Dummy variable
    CUDOS_Score_pre <-  select(Mothership_post, Day1_CUDOS:Day40_CUDOS,dummy)
    CUXOS_Score_pre <- select(Mothership_post, Day1_CUXOS:Day40_CUXOS,dummy)
  
  # Depression
    Pre_DEP <- NA
    PD_df <- NA
    for(i in 1:nrow(CUDOS_Score_pre)){
      PD_df <- unname(unlist(CUDOS_Score_pre[i,]))
      PD_df <- PD_df[!is.na(PD_df)]
      PD_df <- head(PD_df, n=1)
      Pre_DEP <- rbind(Pre_DEP,PD_df)
    }
    Pre_dep <- Pre_DEP[-1]
    
  # Anxiety
    Pre_ANX <- NA
    PA_df <- NA
    for(i in 1:nrow(CUXOS_Score_pre)){
      PA_df <- unname(unlist(CUXOS_Score_pre[i,]))
      PA_df <- PA_df[!is.na(PA_df)]
      PA_df <- head(PA_df, n=1)
      Pre_ANX <- rbind(Pre_ANX,PA_df)
    }
    Pre_anx <- Pre_ANX[-1]

#4 Adding it back to mother ship
    Mothership_post <- Mothership_post |>
      mutate(
        CUDOS_first = ifelse(is.na(BL_CUDOS),Pre_dep,BL_CUDOS),
        CUDOS_first = ifelse(CUDOS_first < 0, NA, CUDOS_first),
        CUXOS_first = ifelse(is.na(BL_CUXOS),Pre_anx,BL_CUXOS),
        CUXOS_first = ifelse(CUXOS_first < 0, NA, CUXOS_first),
        CUDOS_pre = BL_CUDOS,
        CUXOS_pre = BL_CUXOS,
        CUDOS_post = ifelse(!is.na(SUMdep_DC), SUMdep_DC,Post_Dep),
        CUDOS_post = ifelse(CUDOS_post < 0, NA, CUDOS_post),
        CUXOS_post = ifelse(!is.na(SUManx_DC), SUManx_DC,Post_anx),
        CUXOS_post = ifelse(CUXOS_post < 0, NA, CUXOS_post),
#5 Making some other varaibles
        BL_Missing = as.factor(ifelse(is.na(BL_CUXOS), "Anx Missing",
                                      ifelse(is.na(BL_CUDOS), "Dep Missing", "Not Missing"
                                      ))),
        Sig_BL = as.factor(ifelse(BL_CUXOS > 20 & BL_CUDOS > 20, "Sig Both",
                                  ifelse(BL_CUXOS > 20, "Sig Anx",
                                         ifelse(BL_CUDOS > 20, "Sig Dep",
                                                ifelse(is.na(BL_CUXOS),NA,
                                                       ifelse(is.na(BL_CUDOS),NA, "Sub Both"
                                                       )))))),
        Sig_BL_Anx = as.factor(ifelse(BL_CUXOS > 20, "Significant",
                                      ifelse(is.na(BL_CUXOS),NA, "Subclinical"
                                      ))),
        Sig_BL_Dep = as.factor(ifelse(BL_CUDOS > 20, "Significant",
                                      ifelse(is.na(BL_CUDOS),NA, "Subclinical"
                                      ))),
        Sig_Post_Anx = as.factor(ifelse(CUXOS_post > 20, "Significant",
                                        ifelse(is.na(CUXOS_post),NA, "Subclinical"
                                        ))),
        Sig_Post_Dep = as.factor(ifelse(CUDOS_post > 20, "Significant",
                                        ifelse(is.na(CUDOS_post),NA, "Subclinical"
                                        ))),
        Any_Sig_BL = as.factor(ifelse(BL_CUXOS > 20 | BL_CUDOS > 20, "Sig",
                                      ifelse(is.na(BL_CUXOS),NA,
                                             ifelse(is.na(BL_CUDOS),NA, "Sub"
                                             )))),
        Sig_BL = as.factor(ifelse(BL_CUXOS > 20 & BL_CUDOS > 20, "Sig Both",
                                  ifelse(BL_CUXOS > 20, "Sig Anx",
                                         ifelse(BL_CUDOS > 20, "Sig Dep",
                                                ifelse(is.na(BL_CUDOS), NA,
                                                       ifelse(is.na(BL_CUXOS), NA, "Subclinical"
                                                       ))))))
)



# 4. RCI Analysis categorization ------------------------------------------


#devtools::install_github("AWKruijt/JT-RCI")

library(JTRCI)
# library(ClinicalSig)
# 
# #devtools::install_github("zieglema/ClinicalSig")
#1. Create df for RCI
RCI_df_dep <- Mothership_post |>
  mutate(
    ID1  = as.integer(ID1),
    pre  = as.numeric(CUDOS_pre),
    post = as.numeric(CUDOS_post),
    Disorder = Disorder_treat
  ) |>
  select(
    ID1,pre,post,Disorder
  ) |>
  filter(!is.na(pre),
         !is.na(post),
         pre > 20)

RCI_df_anx <- Mothership_post |>
  mutate(
    ID1  = as.integer(ID1),
    pre  = as.numeric(CUXOS_pre),
    post = as.numeric(CUXOS_post),
    Disorder = Disorder_treat
  ) |>
  select(
    ID1,pre,post,Disorder
  ) |>
  filter(!is.na(pre),
         !is.na(post),
         pre > 20)


RCI_df_dep <- data.frame(RCI_df_dep)
RCI_df_anx <- data.frame(RCI_df_anx)

# https://awkruijt.netlify.app/plotposts/longitudinaljtrci

RCI_df_anx1<-RCI_df_anx |>
  select(ID1,pre,post)

DEP_RCI <- JTRCI (data = RCI_df_dep, 
                  pre = "pre", 
                  post = "post", 
                  ppid = "ID1", 
                  reliability = .74, 
                  indextype = "RCI", 
                  #JTcrit = "auto",
                  plottitle = "Anxeity: JT indices by disorder")

ANX_RCI <- JTRCI (data = RCI_df_anx, 
                  pre = "pre", 
                  post = "post", 
                  ppid = "ID1", 
                  reliability = .74, 
                  indextype = "RCI", 
                  #JTcrit = "auto",
                  plottitle = "Anxeity: JT indices by disorder")

RCI_DF<- ANX_RCI$data
colnames(RCI_DF) <- paste0(colnames(RCI_DF),"_anx")

RCI_DF2<- DEP_RCI$data
colnames(RCI_DF2) <- paste0(colnames(RCI_DF2),"_dep")

RCI_DF <- full_join(RCI_DF,RCI_DF2, by = c("ppid_anx" = "ppid_dep"))
colnames(RCI_DF)[1] = "ID1"

RCI_DF
```


```{r}
###############          Adding RCI to dataset       ####################

Mothership_post <- Mothership_post |>
  #1. Filter out scores for people not in the program / don't have data
  filter(!is.na(Days_complete_1)) |>
  #Having people in the program for more than 40 days means that their scores may be a lot higher, they should be filtered out as result. 
  filter(!is.na(CUXOS_pre),
         !is.na(CUXOS_post),
         CUXOS_pre > 0,
         CUXOS_post >= 0,
         !is.na(CUDOS_pre),
         !is.na(CUDOS_post),
         CUDOS_pre > 0,
         CUDOS_post> 0
         ) |>
  mutate(
    Delta_Anx_DC =  CUXOS_post - CUXOS_pre,
    Delta_Dep_DC = CUDOS_post - CUDOS_pre,
    Percent_Anx_change = (Delta_Anx_DC/CUXOS_pre)*100,
    Percent_Dep_Dchange = (Delta_Dep_DC/CUDOS_pre)*100,
    #Days_complete_W = ifelse(Days_complete_1 > 40, 40, Days_complete_1),
    Anx_Responder = as.factor(
      ifelse(CUXOS_pre < 20 & Percent_Anx_change  <= -50, "Responder",
      ifelse(CUXOS_pre < 20 & Percent_Anx_change  > -50,  "Unresponders", NA)   
      )),
    Dep_Responder = as.factor(
      ifelse(CUDOS_pre < 20 & Percent_Dep_Dchange <= -50, "Responder",
      ifelse(CUDOS_pre < 20 & Percent_Dep_Dchange > -50,   "Unresponders", NA) 
      )),
    Treatment_Responder = as.factor(
      ifelse(CUXOS_pre > 10 & CUXOS_pre > 10 & Percent_Anx_change  <= -50 & Percent_Anx_change < 0 & Percent_Dep_Dchange < 0 & Percent_Dep_Dchange <= -50, "Both_Responder", 
      ifelse(CUXOS_pre > 10 & Percent_Anx_change  <= -50, "Anx Responder",
      ifelse(CUDOS_pre > 10 & Percent_Dep_Dchange <= -50, "Dep Responder",
      ifelse(CUDOS_pre > 10 & Percent_Dep_Dchange > 0 & CUXOS_pre > 10 & Percent_Anx_change > 0, "Both Worse",
      ifelse(CUXOS_pre > 10 & Percent_Anx_change > 0, "Anx Worse",
      ifelse(CUDOS_pre > 10 & Percent_Dep_Dchange > 0, "Dep Worse",
      ifelse(CUXOS_pre > 10 & CUDOS_pre > 10 & Percent_Anx_change < 0 & Percent_Anx_change > -50 & Percent_Dep_Dchange < 0 & Percent_Dep_Dchange > -50, "Both Unresponder",
      ifelse(CUDOS_pre > 10 & Percent_Dep_Dchange < 0 & Percent_Dep_Dchange > -50, "Dep Unresponders", 
      ifelse(CUXOS_pre > 10 & Percent_Anx_change < 0 & Percent_Anx_change > -50, "Anx Unresponders", "Low Baseline"
      )))))))))))

#2. Left join data from the RCI dataset into the Mothership_post df
Mothership_post <- left_join(Mothership_post,RCI_DF, by = join_by(ID1 == ID1)) |>
  mutate(
    Depression_Responder = ifelse(!is.na(class_RCI_dep), class_RCI_dep, NA),
    Depression_Responder = as.factor(recode(Depression_Responder,
                                            "1" = "2",
                                            "2" = "2",
                                            "3" = "1"
    )),
    Depression_Responder = as.factor(ifelse(!is.na(Depression_Responder), Depression_Responder, Dep_Responder)),
    Depression_Responder = as.factor(recode(Depression_Responder,
                                            "2" = "Non-Responder",
                                            "1" = "Responder"
    )),
    Anxiety_Responder = ifelse(!is.na(class_RCI_anx), class_RCI_anx, NA),
    Anxiety_Responder = as.factor(recode(Anxiety_Responder,
                                         "1" = "2",
                                         "2" = "2",
                                         "3" = "1"
    )),
    Anxiety_Responder = as.factor(ifelse(!is.na(Anxiety_Responder), Anxiety_Responder, Anx_Responder)),
    Anxiety_Responder = as.factor(recode(Anxiety_Responder,
                                         "2" = "Non-Responder",
                                         "1" = "Responder"
    )),
    RESPONDER_FIGS = as.factor(
      ifelse(Anxiety_Responder == "Responder" | Depression_Responder == "Responder", "Responder",
             ifelse(Anxiety_Responder == "Non-Responder" & Depression_Responder == "Non-Responder", "Non-Responder", NA)
      ))) |>
  filter(!is.na(RESPONDER_FIGS))

#############            AnxDep_PrePost                 ##################

#7. create new DF with Varaibles we want

AnxDep_PrePost <- data.frame(cbind(Mothership_post$ID1,
                                   Mothership_post$Disorder_treat,
                                   Mothership_post$BL_CUDOS,
                                   Mothership_post$BL_CUXOS,
                                   Mothership_post$CUDOS_pre,
                                   Mothership_post$CUDOS_post,
                                   Mothership_post$CUXOS_pre,
                                   Mothership_post$CUXOS_post,
                                   #Extra stuff?
                                   Mothership_post$Depression_Responder,
                                   Mothership_post$Anxiety_Responder,
                                   Mothership_post$RESPONDER_FIGS
)) #%>%
#filter(!is.na(Mothership_post$Disorder_treat))

colnames(AnxDep_PrePost) = c("ID1","Disorder_Type", "BL_CUDOS", "BL_CUXOS", "CUDOS_pre","CUDOS_post","CUXOS_pre","CUXOS_post","Depression_Responder",
                             "Anxiety_Responder", "RESPONDER_FIGS")

#8. Create long data frame

AnxDep_PrePost_Long <- AnxDep_PrePost %>% 
  pivot_longer(
    cols = CUDOS_pre:CUXOS_post, 
    names_to = "Test",
    values_to = "Score"
  )
AnxDep_PrePost_Long <-AnxDep_PrePost_Long %>%
  mutate(
    PrePost = ifelse(
      Test == "CUDOS_pre", "Pre",
      ifelse(Test == "CUXOS_pre" , "Pre", "Post"
      )),
    Score = as.integer(Score),
    Test = as.factor(Test),
    Test = as.factor(ifelse(Test == "CUDOS_pre",  "CUDOS",
                            ifelse(Test == "CUDOS_post", "CUDOS", "CUXOS"
                            ))))  

#9. Convert to data frame with means of values to be plotted
AnxDep_PrePost_mean<-AnxDep_PrePost_Long %>%
  group_by(Test,PrePost) %>%
  summarise(Score=mean(Score,na.rm=TRUE))
```




# Data analysis 
## Part 1: Who is attending?

### Demographics information
- Table 1 Demographics By Response
- Table 2: Treatment information - What did treatment look like?
- Table 3: Scores on measures pre post change? 
    + I want to show the figure of pre-post change???
- Table 4: demographic breakdown
```{r}
#Demographics Table
Demo_tab_df <- Mothership_post |>
  #Mothership_Diag_treat |>
  filter(!is.na(Education_1),
         !is.na(Race_1),
         !is.na(Gender_1),
         !is.na(Disorder_Type),
         !is.na(Relationship_1),
         !is.na(RESPONDER_FIGS)
        )

#Demographic tab
Demo_tab<-data.frame(table1::table1(~Age_1+Race_1+Education_1+Gender_1+Relationship_1 | RESPONDER_FIGS, data=Demo_tab_df))
colnames(Demo_tab) <- c("Demographic","Non-Responder", "Responder","Total Sample")
Demo_tab

Simple_Demo_tab <-data.frame(table1::table1(~Age_1 + White +IPT_track_1 + Straight + Married + Female +  Some_College + Discharge | RESPONDER_FIGS, data=Demo_tab_df))
colnames(Simple_Demo_tab) <- c("Demographic","Non-Responder", "Responder","Total Sample")
Simple_Demo_tab
```

### Treatment information
Overal look at treatment varaibles by treatment response
```{r}
# PHP Treatment information
resp_tab <- data.frame(table1::table1(
   ~ DC_status_1 + IPT_track_1 + Days_complete_1 + Days_cancel_1 + Days_not_attended_1 + Days_noshow_1 | RESPONDER_FIGS, 
  data = Mothership_post))
colnames(resp_tab) <- c("Variable","Non-Responder", "Responder", "Total Sample")
resp_tab
```

pre-post scores by treatment response
```{r}
# Treatment scores
#1. Make DF + name columns
Scores_tab <- data.frame(matrix(nrow = 9 ,ncol=7))
colnames(Scores_tab) = c("Variables", "N_Pre M(SD)", "N_Post M(SD)", "N_Change M(SD)","R_Pre M(SD)", "R_Post M(SD)", "R_Change M(SD)")

#2. Row 1 - responders
Scores_tab[1,] = c(NA,"Non-responder","Non-responder","Non-responder","Responder","Responder","Responder")

#3. Get statistics for variables + Assign to table
  # Anxiety - CUXOS
    #make df
      anx_rep_tab <- Mothership_post |>
        group_by(RESPONDER_FIGS) |>
        summarize(pre_anx = round(mean(CUXOS_pre, na.rm = TRUE),2),
                  pre_anx_sd = round(sd(CUXOS_pre, na.rm = TRUE),2),
                  post_anx = round( mean(CUXOS_post,na.rm = TRUE),2),
                  post_anx_sd = round( sd(CUXOS_post,na.rm = TRUE),2),
                  delta_anx = round( mean(Delta_Anx_DC,na.rm = TRUE),2),
                  delta_anx_sd = round( sd(Delta_Anx_DC, na.rm = TRUE),2)
                  )
# add to scores tab
        Scores_tab[2,] = c(
          "CUXOS",
          #Non-responder scores
          paste0(anx_rep_tab$pre_anx[[1]]," (",anx_rep_tab$pre_anx_sd[[1]],")"),
          paste0(anx_rep_tab$post_anx[[1]]," (",anx_rep_tab$post_anx_sd[[1]],")"),
          paste0(anx_rep_tab$delta_anx[[1]]," (",anx_rep_tab$delta_anx_sd[[1]],")"),
          #responder scores
          paste0(anx_rep_tab$pre_anx[[2]]," (",anx_rep_tab$pre_anx_sd[[2]],")"),
          paste0(anx_rep_tab$post_anx[[2]]," (",anx_rep_tab$post_anx_sd[[2]],")"),
          paste0(anx_rep_tab$delta_anx[[2]]," (",anx_rep_tab$delta_anx_sd[[2]],")")
        )

  # Depression - CUDOS
  #Make df
    dep_rep_tab <- Mothership_post |>
      group_by(RESPONDER_FIGS) |>
      summarize(pre_dep = round( mean(CUDOS_pre, na.rm = TRUE),2),
                pre_dep_sd = round( sd(CUDOS_pre, na.rm = TRUE),2),
                post_dep = round( mean(CUDOS_post, na.rm = TRUE),2),
                post_dep_sd = round( sd(CUDOS_post, na.rm = TRUE),2),
                delta_dep = round( mean(Delta_Dep_DC, na.rm = TRUE),2),
                delta_dep_sd = round( sd(Delta_Dep_DC, na.rm = TRUE),2)
                )
    #Add to Scores_tab
       Scores_tab[3,] = c(
        "CUDOS",
        #Non-responder scores
        paste0(dep_rep_tab$pre_dep[[1]]," (",dep_rep_tab$pre_dep_sd[[1]],")"),
        paste0(dep_rep_tab$post_dep[[1]]," (",dep_rep_tab$post_dep_sd[[1]],")"),
        paste0(dep_rep_tab$delta_dep[[1]]," (",dep_rep_tab$delta_dep_sd[[1]],")"),
        #responder scores
        paste0(dep_rep_tab$pre_dep[[2]]," (",dep_rep_tab$pre_dep_sd[[2]],")"),
        paste0(dep_rep_tab$post_dep[[2]]," (",dep_rep_tab$post_dep_sd[[2]],")"),
        paste0(dep_rep_tab$delta_dep[[2]]," (",dep_rep_tab$delta_dep_sd[[2]],")")
      )
       
  #RDQ subscales
       Scores_tab[4,1] = "RDQ Subscales"
       
  # Coping
      cope_rep_tab <- Mothership_post |>
        group_by(RESPONDER_FIGS) |>
        summarize(pre_cope = round( mean(rdqPRE_coping, na.rm = TRUE),2),
                  pre_cope_sd = round( sd(rdqPRE_coping, na.rm = TRUE),2),
                  post_cope = round( mean(rdqPOST_coping, na.rm = TRUE),2),
                  post_cope_sd = round( sd(rdqPOST_coping, na.rm = TRUE),2),
                  delta_cope = round( mean(rdq_coping_change, na.rm = TRUE),2),
                  delta_cope_sd = round( sd(rdq_coping_change, na.rm = TRUE),2)
              )
      Scores_tab[5,] = c(
        "Coping",
        #Non-responder scores
        paste0(cope_rep_tab$pre_cope[[1]]," (",cope_rep_tab$pre_cope_sd[[1]],")"),
        paste0(cope_rep_tab$post_cope[[1]]," (",cope_rep_tab$post_cope_sd[[1]],")"),
        paste0(cope_rep_tab$delta_cope[[1]]," (",cope_rep_tab$delta_cope_sd[[1]],")"),
        #responder scores
        paste0(cope_rep_tab$pre_cope[[2]]," (",cope_rep_tab$pre_cope_sd[[2]],")"),
        paste0(cope_rep_tab$post_cope[[2]]," (",cope_rep_tab$post_cope_sd[[2]],")"),
        paste0(cope_rep_tab$delta_cope[[2]]," (",cope_rep_tab$delta_cope_sd[[2]],")")
      )
   # Positive mental health
  pmh_rep_tab <- Mothership_post |>
    group_by(RESPONDER_FIGS) |>
    summarize(pre_pmh = round( mean(rdqPRE_pmh, na.rm = TRUE),2),
              pre_pmh_sd = round( sd(rdqPRE_pmh, na.rm = TRUE),2),
              post_pmh = round( mean(rdqPOST_pmh, na.rm = TRUE),2),
              post_pmh_sd = round( sd(rdqPOST_pmh, na.rm = TRUE),2),
              delta_pmh = round( mean(rdq_pmh_change, na.rm = TRUE),2),
              delta_pmh_sd = round( sd(rdq_pmh_change, na.rm = TRUE),2)
              )
         Scores_tab[6,] = c(
              "Positive Mental Health",
              #Non-responder scores
              paste0(pmh_rep_tab$pre_pmh[[1]]," (",pmh_rep_tab$pre_pmh_sd[[1]],")"),
              paste0(pmh_rep_tab$post_pmh[[1]]," (",pmh_rep_tab$post_pmh_sd[[1]],")"),
              paste0(pmh_rep_tab$delta_pmh[[1]]," (",pmh_rep_tab$delta_pmh_sd[[1]],")"),
              #responder scores
              paste0(pmh_rep_tab$pre_pmh[[2]]," (",pmh_rep_tab$pre_pmh_sd[[2]],")"),
              paste0(pmh_rep_tab$post_pmh[[2]]," (",pmh_rep_tab$post_pmh_sd[[2]],")"),
              paste0(pmh_rep_tab$delta_pmh[[2]]," (",pmh_rep_tab$delta_pmh_sd[[2]],")")
            )
   # Functioning
  func_rep_tab <- Mothership_post |>
    group_by(RESPONDER_FIGS) |>
    summarize(pre_func = round( mean(rdqPRE_func, na.rm = TRUE),2),
              pre_func_sd = round( sd(rdqPRE_func, na.rm = TRUE),2),
              post_func = round( mean(rdqPOST_func, na.rm = TRUE),2),
              post_func_sd = round( sd(rdqPOST_func, na.rm = TRUE),2),
              delta_func = round( mean(rdq_func_change, na.rm = TRUE),2),
              delta_func_sd = round( sd(rdq_func_change, na.rm = TRUE),2)
              )    
         Scores_tab[7,] = c(
              "Functioning",
              #Non-responder scores
              paste0(func_rep_tab$pre_func[[1]]," (",func_rep_tab$pre_func_sd[[1]],")"),
              paste0(func_rep_tab$post_func[[1]]," (",func_rep_tab$post_func_sd[[1]],")"),
              paste0(func_rep_tab$delta_func[[1]]," (",func_rep_tab$delta_func_sd[[1]],")"),
              #responder scores
              paste0(func_rep_tab$pre_func[[2]]," (",func_rep_tab$pre_func_sd[[2]],")"),
              paste0(func_rep_tab$post_func[[2]]," (",func_rep_tab$post_func_sd[[2]],")"),
              paste0(func_rep_tab$delta_func[[2]]," (",func_rep_tab$delta_func_sd[[2]],")")
            )

    # General sense of wellbeing
    wbs_rep_tab <- Mothership_post |>
    group_by(RESPONDER_FIGS) |>
    summarize(pre_wbs = round( mean(rdqPRE_wbs, na.rm = TRUE),2),
              pre_wbs_sd = round( sd(rdqPRE_wbs, na.rm = TRUE),2),
              post_wbs = round( mean(rdqPOST_wbs, na.rm = TRUE),2),
              post_wbs_sd = round( sd(rdqPOST_wbs, na.rm = TRUE),2),
              delta_wbs = round( mean(rdq_wbs_change, na.rm = TRUE),2),
              delta_wbs_sd = round( sd(rdq_wbs_change, na.rm = TRUE),2)
              )
    
     Scores_tab[8,] = c(
              "General sense of wellbeing",
              #Non-responder scores
              paste0(wbs_rep_tab$pre_wbs[[1]]," (",wbs_rep_tab$pre_wbs_sd[[1]],")"),
              paste0(wbs_rep_tab$post_wbs[[1]]," (",wbs_rep_tab$post_wbs_sd[[1]],")"),
              paste0(wbs_rep_tab$delta_wbs[[1]]," (",wbs_rep_tab$delta_wbs_sd[[1]],")"),
              #responder scores
              paste0(wbs_rep_tab$pre_wbs[[2]]," (",wbs_rep_tab$pre_wbs_sd[[2]],")"),
              paste0(wbs_rep_tab$post_wbs[[2]]," (",wbs_rep_tab$post_wbs_sd[[2]],")"),
              paste0(wbs_rep_tab$delta_wbs[[2]]," (",wbs_rep_tab$delta_wbs_sd[[2]],")")
            )
    
    #Symptoms
    sym_rep_tab <- Mothership_post |>
    group_by(RESPONDER_FIGS) |>
    summarize(pre_sym = round( mean(rdqPRE_sym, na.rm = TRUE),2),
              pre_sym_sd = round( sd(rdqPRE_sym, na.rm = TRUE),2),
              post_sym = round( mean(rdqPOST_sym, na.rm = TRUE),2),
              post_sym_sd = round( sd(rdqPOST_sym, na.rm = TRUE),2),
              delta_sym = round( mean(rdq_sym_change, na.rm = TRUE),2),
              delta_sym_sd = round( sd(rdq_sym_change, na.rm = TRUE),2)
              )
    
      Scores_tab[9,] = c(
              "Symptoms",
              #Non-responder scores
              paste0(sym_rep_tab$pre_sym[[1]]," (",sym_rep_tab$pre_sym_sd[[1]],")"),
              paste0(sym_rep_tab$post_sym[[1]]," (",sym_rep_tab$post_sym_sd[[1]],")"),
              paste0(sym_rep_tab$delta_sym[[1]]," (",sym_rep_tab$delta_sym_sd[[1]],")"),
              #responder scores
              paste0(sym_rep_tab$pre_sym[[2]]," (",sym_rep_tab$pre_sym_sd[[2]],")"),
              paste0(sym_rep_tab$post_sym[[2]]," (",sym_rep_tab$post_sym_sd[[2]],")"),
              paste0(sym_rep_tab$delta_sym[[2]]," (",sym_rep_tab$delta_sym_sd[[2]],")")
            )
Scores_tab
```

### Disorder Breakdowns
Here are some tables displaying info on the psychiatric disorders treated at the PHP
```{r}
# Disorders by treatment response
Dis_tab <- data.frame(table1::table1(~Disorder_Type + Current_Dx | RESPONDER_FIGS, 
                                     data = Mothership_post))
colnames(Dis_tab) = c("Variables","Non Responder", "Responder", "Total")
Dis_tab


#Full demographic break down

co_dis_tab <- Mothership_post |>
  filter(
      !is.na(rdq_func_change),
      !is.na(rdq_pmh_change),
      !is.na(rdq_coping_change),
      !is.na(rdq_wbs_change)
  ) |>
  pivot_longer(
    cols = c("Anxiety_C","Mood_C","BPD_Co_C","Other_C", "Substance_C","Trauma_C", "No_Co"),
    names_to = 'Co Occuring',
    values_to = "Number"
  ) |>
  select(Disorder_treat, `Co Occuring`, Number) |>
  filter(Number != 0,
         !is.na(`Co Occuring`),
         !is.na(Disorder_treat),
         ) 

CODis_tab<-data.frame(table1::table1(~`Co Occuring` | Disorder_treat, data = co_dis_tab))
colnames(CODis_tab)[1] = c("Variables")
CODis_tab
```

Figure 1: Pre-post Line Plot
```{r}

AnxDep_response_mean<-AnxDep_PrePost_Long %>%
  filter(!is.na(RESPONDER_FIGS)) |>
  group_by(Test,RESPONDER_FIGS,PrePost) %>%
  summarise(Score=mean(Score,na.rm=TRUE))

ggplot(data=AnxDep_response_mean,
       aes(x=factor(PrePost,level=c("Pre","Post")),y=Score,
           group=Test,color=fct_rev(Test)))+
  geom_point(size=2.5) +
  geom_line(group=AnxDep_response_mean$PrePost,size=1.5)+
  scale_x_discrete(name="Time Point")+
  scale_y_continuous(name="CUDOS/CUXOS Score")+
  ggtitle("Mean Pre and Post Scores of the Anxiety and Depression")+
  theme(panel.grid.major.y = element_line(color = "grey",size = 0.5,linetype = 2))+
  theme(panel.background=NULL)+
  theme(legend.title = element_blank()) +
  facet_wrap(~RESPONDER_FIGS,labeller = labeller(RESPONDER_FIGS =
      c("1" = "Non-Responders", 
        "2" = "Responders")
      ))
```

- Table 3: Correlation table?
- supplemental table 1: Full diagnostic breakdown of sample 
  + (co-occuring by Disorder)
```{r}
Vars_FULL <- Mothership_lasso |>
  select( c(
    RESPONDER_FIGS,
    # Demographics
    Age_1,Some_College:Married,White, #Discharge,
    # Treatment info
    IPT_track_1, Days_complete_1, Days_not_attended_1, #Days_cancel_1,
    # Disorders
    Anxiety_D, Mood_D, BPD_P, Trauma_D, Other,
    Anxiety_C,Mood_C,BPD_Co_C,Other_C, Substance_C, Trauma_C, No_Co,
    Current_Dx,
    # Pre-Post stuff
    CUDOS_pre,CUXOS_pre, #CUDOS_first,CUXOS_first
    # RDQ
    rdq_coping_change:rdq_wbs_change
  ))
Vars_FULL <- na.omit(Vars_FULL)

# install.packages("ggcorrplot")
library(ggcorrplot)
model.matrix(~0+., data=Vars_FULL) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)
```


## Part 2: RCI ANALYSIS - Treatment Response
Anxiety & Depression = Total response
- Table 4: RCI Analsyis results
  + Anxiety, Depression, Total response
- Figure 2 / Supplimetal 2: RCI Analysis figs 
  + Anxeity & Depression
```{r}

RCI_table <- data.frame(matrix(NA,nrow = 3,ncol = 3))
colnames(RCI_table) = c("Varaibles","Responder","Non-Responder")
#anxiety 
RCI_table[1,] = c("CUXOS", unlist(summary(Mothership_post$Anxiety_Responder)))
# Depresssion
RCI_table[2,] = c("CUDOS", unlist(summary(Mothership_post$Depression_Responder)))
#Total
RCI_table[3,] = c("Either", unlist(summary(Mothership_post$RESPONDER_FIGS))[2],unlist(summary(Mothership_post$RESPONDER_FIGS))[1])

RCI_table
```


## Part 3 Logistic lasso

### Lasso Regression
https://glmnet.stanford.edu/articles/glmnet.html
https://www.mygreatlearning.com/blog/understanding-of-lasso-regression/
https://bookdown.org/tpinto_home/Regularisation/lasso-regression.html

https://github.com/sydeaka/Using-Elastic-net-for-model-Selection-with-missing-data/blob/master/model_selection_missing_data-example.R
http://www.sthda.com/english/articles/36-classification-methods-essentials/149-penalized-logistic-regression-essentials-in-r-ridge-lasso-and-elastic-net/

Preparing data for Lasso
\scriptsize
```{r, warning=FALSE, message=FALSE}
library(glmnet)
library(caret)
#Make sure there are no NAs within the dataset
Mothership_lasso <- Mothership_post |>
    filter(
    !is.na(Some_College),
    !is.na(Female),
    !is.na(IPT_track_1),
    !is.na(White),
    !is.na(RESPONDER_FIGS)
  )

# View(Mothership_lasso)

Vars <- Mothership_lasso |>
  select( c(
    RESPONDER_FIGS,
    # Demographics
    Age_1,Some_College:Married,White,
    # Treatment info
    IPT_track_1, Days_complete_1, Days_not_attended_1, 
    # Disorders
    Anxiety_D, Mood_D, BPD_P, Trauma_D, Other,
    Anxiety_C,Mood_C,BPD_Co_C,Other_C, Substance_C, Trauma_C, No_Co,
    Current_Dx,
    # Pre-Post stuff
    CUDOS_pre,CUXOS_pre, 
  ))

```


```{r, warning=FALSE, message=FALSE}
# View(Mothership_lasso)
# head(Vars)
# sum(is.na(Vars))
Vars_FULL <- Mothership_lasso |>
  select( c(
    RESPONDER_FIGS,
    # Demographics
    Age_1,Some_College:Married,White, #Discharge,
    # Treatment info
    IPT_track_1, Days_complete_1, Days_not_attended_1, #Days_cancel_1,
    # Disorders
    Anxiety_D, Mood_D, BPD_P, Trauma_D, Other,
    Anxiety_C,Mood_C,BPD_Co_C,Other_C, Substance_C, Trauma_C, No_Co,
    Current_Dx,
    # Pre-Post stuff
    CUDOS_pre,CUXOS_pre, #CUDOS_first,CUXOS_first
    # RDQ
    rdq_coping_change:rdq_wbs_change
  ))

Vars_FULL <- na.omit(Vars_FULL)
```
# with RDQ
```{r}
# Create Training and testing data
set.seed(123) 
training.samples <- Vars_FULL$RESPONDER_FIGS %>% 
  createDataPartition(p = 0.8, list = FALSE)
train.data  <- Vars_FULL[training.samples, ]
test.data <- Vars_FULL[-training.samples, ]

# Dumy code categorical predictor variables
x <- model.matrix(RESPONDER_FIGS~., train.data)[,-1]
# Convert the outcome (class) to a numerical variable
y <- ifelse(train.data$RESPONDER_FIGS == "Responder", 1, 0)

#Simplified lasso
lasso1 <- glmnet(x, y,family = "binomial", alpha = 1, lambda = NULL)
plot(lasso1, "lambda", label = TRUE)
```

Find coefficients using cv.lasso
```{r}
# Find the best lambda using cross-validation
set.seed(123) 
cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "binomial")

#The exact value of lambda can be viewed as follow:
print(paste0("This is the minimum lambda value: ", round(cv.lasso$lambda.min,5)))

#This value is called lambda.1se.
print(paste0("This is the 1 standard error lambda value: ", round(cv.lasso$lambda.1se,5)))

# Fit the final model on the training data
model <- glmnet(x, y, alpha = 1, family = "binomial",
                lambda = cv.lasso$lambda.min)
# Display regression coefficients
coef(model)
# Make predictions on the test data
x.test <- model.matrix(RESPONDER_FIGS ~., test.data)[,-1]
probabilities <- model %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$RESPONDER_FIGS
mean(predicted.classes == observed.classes)

#Using lambda.min as the best lambda, gives the following regression coefficients:
coef(cv.lasso, cv.lasso$lambda.min)

#Using lambda.1se as the best lambda, gives the following regression coefficients:
coef(cv.lasso, cv.lasso$lambda.1se)
```

Evaluating if we should use Lasso min or 1SE
```{r}
####  Using Min
# Final model with lambda.min
lasso.model.min <- glmnet(x, y, alpha = 1, family = "binomial",
                      lambda = cv.lasso$lambda.min)

coef(lasso.model.min)
# Make prediction on test data
x.test <- model.matrix(RESPONDER_FIGS ~., test.data)[,-1]
probabilities <- lasso.model.min %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$RESPONDER_FIGS
Mean.predict.min <- mean(predicted.classes == observed.classes)

#####  using 1se
# Final model with lambda.1se
lasso.model.1se <- glmnet(x, y, alpha = 1, family = "binomial",
                      lambda = cv.lasso$lambda.1se)
coef(lasso.model.1se)
# Make prediction on test data
x.test <- model.matrix(RESPONDER_FIGS ~., test.data)[,-1]
probabilities <- lasso.model.1se %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")

# Model accuracy rate
observed.classes <- test.data$RESPONDER_FIGS
Mean.predict.1se <- mean(predicted.classes == observed.classes)

#### full model
# Fit the model
full.model <- glm(RESPONDER_FIGS ~ ., data = train.data, family = "binomial")

# Make predictions
probabilities <- full.model %>% predict(test.data, type = "response")
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$RESPONDER_FIGS
Mean.predict.full.model <- mean(predicted.classes == observed.classes)

predict.df <- data.frame(
  model = c("Min", "1se", "Full"),
  values = c(Mean.predict.min,Mean.predict.1se,Mean.predict.full.model)
)
predict.df
```
plot the lassos
If We want to do lasso in ggplot
https://stackoverflow.com/questions/48978179/plotting-lasso-beta-coefficients

```{r}
##plot the lambda
plot(lasso1, "lambda", label = TRUE)
## Fancy plot
library(lars)
lasso_FULL = lars(x, y, type='lasso', 
              trace=TRUE, normalize=FALSE, intercept=TRUE)
plot(lasso_FULL, xvar='norm', breaks = FALSE, 
     plottype = 'coefficients', omit.zeros = TRUE)

#CV k folds cross validation
plot(cv.lasso)
```

### Final relaxed lasso
Minimum
```{r}
## install.packages("fuzzySim")
library(fuzzySim) ## For FDR adjusted p values
FDR(pvalues = p_values.min)

library(broom)
# https://cran.r-project.org/web/packages/broom/vignettes/broom.html

## min model
  glm_min <-  
      glm(
      #Outcome varaible
        RESPONDER_FIGS ~ 
      # predictors
        Days_not_attended_1 + Anxiety_D + Mood_D + Substance_C + 
        rdq_coping_change + rdq_pmh_change + rdq_func_change + rdq_wbs_change,
      #data
      data = Vars_FULL, 
      # type of regression : logistic = binary / binomial
      family = "binomial")
# Summary of the model
  summary.min      <- summary(glm_min)

  tidy.summary.min <- tidy(glm_min)

# Coefficients
  coefs.min <- abs(coef(glm_min))
  
# Odds ratio
  OR.min <- exp(coef(glm_min))
  
# OR 95% CI
  CI.min <- data.frame(exp(confint(glm_min)))
  
# P values
  p.values.min <- data.frame(cbind(tidy.summary.min$term,tidy.summary.min$p.value))
  # FDR Adjusted P Values
    adj.p.min <- FDR(pvalues = p_values.min)
    ADJ.p.values.min <- data.frame(rbind(adj.p.min$exclude, adj.p.min$select))

# R^2 values  
   R2.min <- performance::r2(glm_min)

# df for Forrest plots
FP.min <- data.frame(cbind(
  Variable = tidy.summary.min$term[2:length(tidy.summary.min$term)],
  OR = OR.min[2:length(OR.min)],
  OR_low  = CI.min[2:length(CI.min$X2.5..),1],
  OR_high = CI.min[2:length(CI.min$X97.5..),2],
  p.values = p.values.min$X2[2:length(p.values.min$X2)]
                    ))

# Left join the FDR adjusted p.value
FP.min <- left_join(FP.min,ADJ.p.values.min, by = join_by(p.values == p.value))
FP.min
```

1se
```{r}
glm_1se <-  
      glm(
      #Outcome varaible
        RESPONDER_FIGS ~ 
      # predictors
        Days_not_attended_1 + rdq_coping_change + rdq_pmh_change + rdq_func_change +
        rdq_wbs_change,
      #data
      data = Vars_FULL, 
      # type of regression : logistic = binary / binomial
      family = "binomial")

summary(glm_1se)

# Summary of the model
  summary.1se      <- summary(glm_1se)

  tidy.summary.1se <- tidy(glm_1se)

# Coefficients
  coefs.1se <- abs(coef(glm_1se))
  
# Odds ratio
  OR.1se <- exp(coef(glm_1se))
  
# OR 95% CI
  CI.1se <- data.frame(exp(confint(glm_1se)))
  
# P values
  p.values.1se <- data.frame(cbind(tidy.summary.1se$term,tidy.summary.1se$p.value))
 
  # FDR Adjusted P Values
    adj.p.1se <- FDR(pvalues = p.values.1se)
    ADJ.p.values.1se <- data.frame(rbind(adj.p.1se$exclude, adj.p.1se$select))

# R^2 values  
   R2.1se <- performance::r2(glm_1se)

# df for Forrest plots
FP.1se <- data.frame(cbind(
  Variable = tidy.summary.1se$term[2:length(tidy.summary.1se$term)],
  OR = OR.1se[2:length(OR.1se)],
  OR_low  = CI.1se[2:length(CI.1se$X2.5..),1],
  OR_high = CI.1se[2:length(CI.1se$X97.5..),2],
  p.values = p.values.1se$X2[2:length(p.values.1se$X2)]
                    ))

# Left join the FDR adjusted p.value
FP.1se <- left_join(FP.1se,ADJ.p.values.1se, by = join_by(p.values == p.value))
FP.1se
```



# Without RDQ
Evaluating Methods of Assessing Optimism  in Regression Models Daniel Thoya1,*, Antony Waititu1, Thomas Magheto1, Antony Ngunyi2 
- chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/http://article.sciappliedmathematics.com/pdf/ajams-6-4-2.pdf

Validation of prediction models based on lasso regression with multiply imputed data
- https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/1471-2288-14-116#Sec18

Penalized Logistic Regression Essentials in R: Ridge, Lasso and Elastic Net
http://www.sthda.com/english/articles/36-classification-methods-essentials/149-penalized-logistic-regression-essentials-in-r-ridge-lasso-and-elastic-net/

### Lasso regression - set variables
```{r}
# Create Training and testing data
set.seed(123) 
training.samples <- Vars_full$RESPONDER_FIGS %>% 
  createDataPartition(p = 0.8, list = FALSE)
train.data  <- Vars[training.samples, ]
test.data <- Vars[-training.samples, ]

# Dumy code categorical predictor variables
x <- model.matrix(RESPONDER_FIGS~., train.data)[,-1]
# Convert the outcome (class) to a numerical variable
y <- ifelse(train.data$RESPONDER_FIGS == "Responder", 1, 0)

#Simplified lasso
lasso1 <- glmnet(x, y,family = "binomial", alpha = 1, lambda = NULL)

plot(lasso1, "lambda", label = TRUE)
```

Find coefficients using cv.lasso
```{r}
# Find the best lambda using cross-validation
cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "binomial")
# Fit the final model on the training data
model <- glmnet(x, y, alpha = 1, family = "binomial",
                lambda = cv.lasso$lambda.min)
# Display regression coefficients
coef(model)
# Make predictions on the test data
x.test <- model.matrix(RESPONDER_FIGS ~., test.data)[,-1]
probabilities <- model %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$RESPONDER_FIGS
mean(predicted.classes == observed.classes)

### Compute lasso regression
#Find the optimal value of lambda that minimizes the cross-validation error:
set.seed(123)
cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "binomial")

#The exact value of lambda can be viewed as follow:
cv.lasso$lambda.min

#This value is called lambda.1se.
cv.lasso$lambda.1se

#Using lambda.min as the best lambda, gives the following regression coefficients:
coef(cv.lasso, cv.lasso$lambda.min)

#Using lambda.1se as the best lambda, gives the following regression coefficients:
coef(cv.lasso, cv.lasso$lambda.1se)
```

Evaluating if we should use Lasso min or SE
```{r}
#### Compute the final lasso model:
# Final model with lambda.min
lasso.model.min <- glmnet(x, y, alpha = 1, family = "binomial",
                      lambda = cv.lasso$lambda.min)

coef(lasso.model.min)
# Make prediction on test data
x.test <- model.matrix(RESPONDER_FIGS ~., test.data)[,-1]
probabilities <- lasso.model.min %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$RESPONDER_FIGS
mean(predicted.classes == observed.classes)

#####  using 1se
# Final model with lambda.1se
lasso.model.1se <- glmnet(x, y, alpha = 1, family = "binomial",
                      lambda = cv.lasso$lambda.1se)

# Make prediction on test data
x.test <- model.matrix(RESPONDER_FIGS ~., test.data)[,-1]
probabilities <- lasso.model.1se %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")

# Model accuracy rate
observed.classes <- test.data$RESPONDER_FIGS
mean(predicted.classes == observed.classes)

#### full model
# Fit the model
full.model <- glm(RESPONDER_FIGS ~ ., data = train.data, family = "binomial")

# Make predictions
probabilities <- full.model %>% predict(test.data, type = "response")
predicted.classes <- ifelse(probabilities > 0.5, "Responder", "Non-Responder")
# Model accuracy
observed.classes <- test.data$RESPONDER_FIGS
mean(predicted.classes == observed.classes)
```

Visualizing it
```{r}
library(lars)

lasso5 = lars(x, y, type='lasso', 
              trace=TRUE, normalize=FALSE, intercept=TRUE)

plot(lasso5, xvar='norm', breaks = FALSE, 
     plottype = 'coefficients', omit.zeros = TRUE)
```

### Final relaxed lasso
```{r}
## min model
  glm_1se <-  
      glm(RESPONDER_FIGS ~ 
      Days_complete_1 + Days_not_attended_1,
      data = Vars, family = "binomial")
# Summary of the model
  summary.1se      <- summary(glm_1se)
      library(broom)
          # https://cran.r-project.org/web/packages/broom/vignettes/broom.html
  tidy.summary.1se <- tidy(glm_1se)
  
# Coefficients
  coefs.1se <- abs(coef(glm_1se))
  
# Odds ratio
  OR.1se <- exp(coef(glm_1se))
  
# OR 95% CI
  CI.1se <- data.frame(exp(confint(glm_1se)))
  
# P values
  p.values.1se <- tidy.summary.1se$p.value
  
# R^2 values  
   R2.1se <- performance::r2(glm_1se)

# df for Forrest plots
   
FP.1se <- data.frame(cbind(
  Variable = tidy.summary.1se$term[2:length(tidy.summary.1se$term)],
  OR = OR.1se[2:length(OR.1se)],
  OR_low  = CI.1se[2:length(CI.1se$X2.5..),1],
  OR_high = CI.1se[2:length(CI.1se$X97.5..),2],
  p.values = p.values.1se[2:length(p.values.1se)]
                    ))

FP.1se
```

```{r}
### min model
  glm_min <-  
      glm(RESPONDER_FIGS ~ 
      Age_1 + Some_College + Married + Days_complete_1 + Days_not_attended_1 + 
      Psychotic_D + Co_Substance + Co_Trauma + CUDOS_pre,
      data = Vars, family = "binomial")
# Summary of the model
  summary.min      <- summary(glm_min)
      library(broom)
          # https://cran.r-project.org/web/packages/broom/vignettes/broom.html
  tidy.summary.min <- tidy(glm_min)
  
# Coefficients
  coefs.min <- abs(coef(glm_min))
  
# Odds ratio
  OR.min <- exp(coef(glm_min))
  
# OR 95% CI
  CI.min <- data.frame(exp(confint(glm_min)))
  
# P values
  p.values.min <- tidy.summary.min$p.value
  
# R^2 values  
   R2.min <- performance::r2(glm_min)

# df for Forrest plots
   
FP.min <- data.frame(cbind(
  Variable = tidy.summary.min$term[2:length(tidy.summary.min$term)],
  OR = OR.min[2:length(OR.min)],
  OR_low  = CI.min[2:length(CI.min$X2.5..),1],
  OR_high = CI.min[2:length(CI.min$X97.5..),2],
  p.values = p.values.min[2:length(p.values.min)]
                    ))

FP.min
```
